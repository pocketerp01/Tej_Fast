using System;
using System.Data;
using System.Web;
using System.Web.UI;
using System.Web.UI.HtmlControls;
using System.Web.UI.WebControls;
using System.Web.UI.WebControls.WebParts;


public partial class parta_rpt : System.Web.UI.Page
{
    string frm_mbr, constr, frm_vty, frm_vnum, frm_url, frm_qstr, frm_cocd, frm_uname, frm_tabname, frm_myear, frm_sql, frm_ulvl, frm_formID, frm_UserID;
    string xprdRange;
    string btnval, SQuery, col1, col2, col3, vchnum, vardate, fromdt, todt, DateRange, year, vty, HCID, ulvl, tabname, merr = "0", pk_error;
    string indType = "";
    DataTable dt, dt1; DataRow oporow; DataSet oDS; int i = 0;
    int totCol = 51;
    // fgen_fun fgen = new fgen_fun();
    fgenDB fgen = new fgenDB();
    DataSet ds = new DataSet();
    protected void Page_Load(object sender, EventArgs e)
    {
        if (Request.UrlReferrer == null) Response.Redirect("~/login.aspx");
        else
        {
            frm_url = HttpContext.Current.Request.Url.AbsoluteUri;
            if (frm_url.Contains("STR"))
            {
                if (Request.QueryString["STR"].Length > 0)
                {
                    frm_qstr = Request.QueryString["STR"].Trim().ToString().ToUpper();
                    if (frm_qstr.Contains("@"))
                    {
                        frm_formID = frm_qstr.Split('@')[1].ToString();
                        frm_qstr = frm_qstr.Split('@')[0].ToString();
                        fgenMV.Fn_Set_Mvar(frm_qstr, "U_FORMID", frm_formID);
                    }
                    btnnew.Focus();
                    frm_cocd = fgenMV.Fn_Get_Mvar(frm_qstr, "U_COCD");
                    frm_uname = fgenMV.Fn_Get_Mvar(frm_qstr, "U_UNAME");
                    frm_myear = fgenMV.Fn_Get_Mvar(frm_qstr, "U_YEAR");
                    frm_ulvl = fgenMV.Fn_Get_Mvar(frm_qstr, "U_ULEVEL");
                    frm_mbr = fgenMV.Fn_Get_Mvar(frm_qstr, "U_MBR");
                    DateRange = fgenMV.Fn_Get_Mvar(frm_qstr, "U_DATERANGE");
                    frm_UserID = fgenMV.Fn_Get_Mvar(frm_qstr, "U_USERID");
                    vardate = fgen.Fn_curr_dt(frm_cocd, frm_qstr);

                    fromdt = fgenMV.Fn_Get_Mvar(frm_qstr, "U_Cdt1");
                    todt = fgenMV.Fn_Get_Mvar(frm_qstr, "U_Cdt2");

                    DateRange = "between to_Date('" + fromdt + "','dd/mm/yyyy') and to_Date('" + todt + "','dd/mm/yyyy')";
                }
                else Response.Redirect("~/login.aspx");
            }
            if (!Page.IsPostBack)
            {
                fgen.DisableForm(this.Controls);
                enablectrl(); btnnew.Focus();
            }
            set_Val();
        }
    }
    //------------------------------------------------------------------------------------
    public void enablectrl()
    {
        btnnew.Disabled = false; btnedit.Disabled = false; btnsave.Disabled = false; btndel.Disabled = false;
        btnext.Visible = true; btncan.Visible = false; btnhideF.Enabled = true; btnhideF_s.Enabled = true;
    }
    //------------------------------------------------------------------------------------
    public void disablectrl()
    {
        btnnew.Disabled = true; btnedit.Disabled = true; btnsave.Disabled = true; btndel.Disabled = true;
        btnhideF.Enabled = true; btnhideF_s.Enabled = true; btnext.Visible = false; btncan.Visible = true;
    }
    //------------------------------------------------------------------------------------
    public void clearctrl()
    {
        hffield.Value = ""; edmode.Value = "";
    }
    //------------------------------------------------------------------------------------
    public void set_Val()
    {
        HCID = frm_formID;
        lblheader.Text = "Parta Report";
        indType = "CORR";
        if (frm_cocd == "OMNI")
            indType = "FLEX";
    }
    //------------------------------------------------------------------------------------
    public void disp_data()
    {
        btnval = hffield.Value;
        switch (btnval)
        {
            case "":
                SQuery = "";
                break;
            default:
                if (btnval == "Edit" || btnval == "Del" || btnval == "Print")
                    SQuery = "";
                break;
        }
        if (SQuery.Length > 0)
        {
            //fgen.send_cookie("xid", "Tejaxo");
            //fgen.send_cookie("srchSql", SQuery);
            fgenMV.Fn_Set_Mvar(frm_qstr, "U_XID", "Tejaxo");
            fgenMV.Fn_Set_Mvar(frm_qstr, "U_SEEKSQL", SQuery);

        }
    }
    //------------------------------------------------------------------------------------
    protected void btnnew_ServerClick(object sender, EventArgs e)
    {
        clearctrl(); set_Val();
        hffield.Value = "New";
        //   vchnum = fgen.next_no(co_cd, "select max(vchnum) as vch from " + tabname + " where branchcd='" + frm_mbr + "' and type='" + vty + "' and vchdate " + DateRange + "", 6, "vch");
        vchnum = fgen.next_no(frm_qstr, frm_cocd, "select max(vchnum) as vch from " + tabname + " where branchcd='" + frm_mbr + "' and type='" + vty + "' and vchdate " + DateRange + "", 6, "vch");
    }
    //------------------------------------------------------------------------------------
    protected void btnedit_ServerClick(object sender, EventArgs e)
    {
        clearctrl(); set_Val();
        hffield.Value = "Edit";
        disp_data();
        fgen.Fn_open_sseek("-", frm_qstr);
    }
    //------------------------------------------------------------------------------------
    protected void btnsave_ServerClick(object sender, EventArgs e)
    {
        fgen.Fn_open_prddmp1("-", frm_qstr);
        // fgen.Fn_open_sseek("-", frm_qstr);
    }
    //------------------------------------------------------------------------------------
    protected void btndel_ServerClick(object sender, EventArgs e)
    {
        clearctrl(); set_Val();
        hffield.Value = "Del";
        disp_data();
        fgen.Fn_open_sseek("-", frm_qstr);
    }
    //------------------------------------------------------------------------------------
    protected void btnext_ServerClick(object sender, EventArgs e)
    {
        Response.Redirect("~/tej-base/desktop.aspx?STR=" + frm_qstr);
    }
    //------------------------------------------------------------------------------------
    protected void btncan_ServerClick(object sender, EventArgs e)
    {
        fgen.ResetForm(this.Controls);
        fgen.DisableForm(this.Controls);
        clearctrl();
        enablectrl();
    }
    //------------------------------------------------------------------------------------
    protected void btnlist_ServerClick(object sender, EventArgs e)
    {
        clearctrl();
        hffield.Value = "List";
        disp_data();
        fgen.Fn_open_sseek("-", frm_qstr);
    }
    //------------------------------------------------------------------------------------
    protected void btnprint_ServerClick(object sender, EventArgs e)
    {
        hffield.Value = "Print";
        disp_data();
        fgen.Fn_open_sseek("-", frm_qstr);
    }
    //------------------------------------------------------------------------------------
    protected void btnhideF_Click(object sender, EventArgs e)
    {
        btnval = hffield.Value; set_Val();
        if (hffield.Value == "D")
        {
            col1 = Request.Cookies["REPLY"].Value.ToString().Trim();
            if (col1 == "Y")
            {
                fgen.execute_cmd(frm_qstr, frm_cocd, "delete from " + tabname + " a where a.branchcd||a.type||trim(a.vchnum)||to_char(a.vchdate,'dd/mm/yyyy')='" + edmode.Value + "'");
                fgen.msg("-", "AMSG", "Details are deleted for order " + edmode.Value.Substring(4, 6) + "");
                clearctrl(); fgen.ResetForm(this.Controls);
            }
        }
        else
        {
            //col1 = Request.Cookies["Value1"].Value.ToString().Trim().Replace("&amp", "");
            //col2 = Request.Cookies["Value2"].Value.ToString().Trim().Replace("&amp", "");
            //col3 = Request.Cookies["Value3"].Value.ToString().Trim().Replace("&amp", "");
            col1 = fgenMV.Fn_Get_Mvar(frm_qstr, "U_COL1").ToString().Trim().Replace("&amp", "");
            col2 = fgenMV.Fn_Get_Mvar(frm_qstr, "U_COL2").ToString().Trim().Replace("&amp", "");
            col3 = fgenMV.Fn_Get_Mvar(frm_qstr, "U_COL3").ToString().Trim().Replace("&amp", "");
            switch (btnval)
            {
                case "Del":
                    clearctrl();
                    edmode.Value = col1;
                    fgen.msg("-", "CMSG", "Are You Sure!! You Want to Delete");
                    hffield.Value = "D";
                    break;
                case "Edit":
                    clearctrl();
                    SQuery = "Select a.* from " + tabname + " a where a.branchcd||a.type||trim(a.vchnum)||to_Char(a.vchdate,'dd/mm/yyyy')='" + col1 + "'";
                    ViewState["fstr"] = col1;
                    break;
                case "Print":

                    break;
                case "List":

                    break;
            }
        }
    }
    //------------------------------------------------------------------------------------
    protected void btnhideF_s_Click(object sender, EventArgs e)
    {
        string mq0, mq1;
        //fromdt = Request.Cookies["Value1"].Value.ToString().Trim().Replace("&amp", "");
        //todt = Request.Cookies["Value2"].Value.ToString().Trim().Replace("&amp", "");
        fromdt = fgenMV.Fn_Get_Mvar(frm_qstr, "U_MDT1").ToString().Trim().Replace("&amp", "");
        todt = fgenMV.Fn_Get_Mvar(frm_qstr, "U_MDT2").ToString().Trim().Replace("&amp", "");

        DateRange = "between to_Date('" + fromdt + "','dd/mm/yyyy') and to_date('" + todt + "','dd/mm/yyyy')";
        xprdRange = DateRange;

        //mq0 = "SELECT trim(a.enqno)||to_char(a.enqdt,'dd/mm/yyyy') as fstr,A.ENQNO AS JOBNO,TO_CHAR(A.ENQDT,'DD/MM/YYYY') AS JOBDT,A.ACODE AS ERPCODE,B.INAME AS PRODUCT,B.CPARTNO AS PARTNO,c.col15 as ply,A.COL13 as ups,A.TOT_BOX_RCV as TOT_BOX_REQ,a.STD_SHT_RQ as STD_SHT_RQ_WITH_WSTG, /* (a.STD_SHT_RQ*(is_number(c.col2)/1000)) AS std_MTR_reqd,*/ round(a.enr2/a.STD_SHT_RQ,4) AS STD_WT_PER_SHEET_per_JC,round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) AS STD_WT_PERBOX_per_JC,(CASE WHEN A.COL13>0 THEN round(A.QTYOUT/A.COL13,2) ELSE A.COL3 END) AS NO_OF_SHT_RCVD,A.QTYOUT AS BOX_to_be_PRODUCED,(CASE WHEN is_number(C.BTCHDT)>0 THEN ROUND((A.QTYOUT*is_number(C.BTCHDT))/100,2) ELSE 0 END) AS LINEAR_MTR_TO_BE_PROD,round(round(a.enr2/a.STD_SHT_RQ,4) * (CASE WHEN A.COL13>0 THEN round(A.QTYOUT/A.COL13,2) ELSE A.COL3 END),3) AS STD_WT_rQD,A.QTYIN AS WT_CONSUME,a.scrp1 as gsm_var,a.scrp2 as fala,a.time1 as tore,a.time2 as core,(A.QTYIN - (round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ) /A.COL13,3)),3))) as CORR_STD_VS_ACT_wt_DIFF,d.CORR_STG_REJ,d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) as CORR_WT_LOSS,d.mlt_loss as print_stg_rej,(d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as prt_wt_loss,D.mlt_loss1 as gluing,(d.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as glu_wt_loss,d.snp as sorting_packing_rej,(d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4)) as  sorting_packing_loss , D.mlt_loss2 as other_S,(d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as oth_wt_loss, (  (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + (D.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3))) + (d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) + (d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4)) as paper_Wstg,round(d.CORR_STG_REJ+d.mlt_loss+D.mlt_loss1+d.snp+D.mlt_loss2,2) AS TOTL_REJN_NO,A.IQTYIN AS FINAL_BOX_PROD,round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4) as FINAL_BOX_PROD_WEIGHT,A.QTYIN - round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4) as WT_DIFF,ROUND((A.QTYIN - round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4)) / (CASE WHEN A.QTYIN>0 THEN A.QTYIN ELSE 1 END)  * 100 , 3) AS WT_WISE_REJ_PER,round(((A.QTYOUT - A.IQTYIN) / (case when A.QTYOUT>0 then a.qtyout else 1 end)) * 100,3) AS BOX_WISE_REJ,(CASE WHEN (A.QTYOUT-A.IQTYIN)<0 THEN ABS(A.QTYOUT-A.IQTYIN) ELSE 0 END) AS EXCESS,(CASE WHEN (A.QTYOUT-A.IQTYIN)>0 THEN ABS(A.QTYOUT-A.IQTYIN) ELSE 0 END) AS SHORTAGE,round((case when A.QTYIN>0 and a.val>0 then round(a.val/A.QTYIN,2) else 0 end),4) as matl_avg_rate, round( (A.QTYIN - (round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ) /A.COL13,3)),3))) + (  (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + (D.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3))) + (d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) + (d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4))) * round((case when A.QTYIN>0 and a.val>0 then round(a.val/A.QTYIN,2) else 0 end),4) as cost_of_wstg,(A.IQTYIN*A.SALERATE) as job_vALUE,A.VAL AS mat_cost, (case when (A.IQTYIN*A.SALERATE)>0 then round(((A.IQTYIN*A.SALERATE)-a.val) / (A.IQTYIN*A.SALERATE) ,3)*100 else 0 end ) as proft_per,round((A.IQTYIN*A.SALERATE)-a.val ,3) as profit_Value /*,ROUND((CASE WHEN A.TOT_BOX_RCV>0 THEN ((A.TOT_BOX_RCV-A.QTYOUT)/A.TOT_BOX_RCV)*100 ELSE 0 END),2)  as variation_per*/ FROM (SELECT A.*,B.QTY AS TOT_BOX_RCV,(B.COL14+B.COL15) AS STD_SHT_RQ,b.enr1,b.enr2,B.COL13,c.IRATE AS SALERATE FROM (select enqno,enqdt,acode,sum(qtyin) as qtyin,sum(qtyout) as qtyout,sum(scrp1) as scrp1,sum(scrp2) as scrp2,sum(time1) as time1,sum(time2) as time2,sum(COL3) as col3,SUM(IQTYIN) AS IQTYIN,SUM(VAL) AS VAL from (select INVNO AS ENQNO,INVDATE AS ENQDT,TRIM(ICODE) AS ACODE,0 as qtyin,0 as qtyout,0 AS COL3,0 as scrp1,0 as scrp2,0 as time1,0 as time2,SUM(IQTYIN) AS IQTYIN,0 AS VAL from IVOUCHER where BRANCHCD='" + frm_mbr + "' AND type='16' and INVDATE " + DateRange + " group by INVNO,INVDATE,TRIM(ICODE) union all select A.enqno,A.enqdt,TRIM(A.aCODE) AS ACODE,sum(A.itate) as qtyin,0 as qtyout,0 AS COL3,sum(A.scrp1) as scrp1,sum(A.scrp2) as scrp2,sum(A.time1) as time1,sum(A.time2) as time2,0 AS QTYIN1,SUM((case when b.irate>0 then ROUND(is_number(A.col4)*B.IRATE,2) else ROUND(is_number(A.col4)*c.IRATE,2) end)) AS VAL from item c,costestimate A left outer join REELVCH B on A.BRANCHCD||TRIM(A.ICODe)||TRIM(A.COL6)=B.BRANCHCD||TRIM(B.ICODe)||TRIM(B.KCLREELNO) and b.type in ('02','07') where trim(a.icode)=trim(c.icodE) and A.BRANCHCD='" + frm_mbr + "' AND A.type='25' and A.enqdt " + DateRange + " group by A.enqno,A.enqdt,TRIM(A.aCODE) union all select a.enqno,a.enqdt,TRIM(a.aCODE) AS ACODE,0 as qtyin,sum(a.qty + is_number(replace(nvl(b.COL3,'0'),'-','0')) ) as qtyout,is_number(replace(nvl(a.COL3,'0'),'-','0')) as col3,sum(a.scrp1) as scrp1,sum(a.scrp2) as scrp2,sum(a.time1) as time1,sum(a.time2) as time2,0 AS QTYIN1,0 AS VAL from costestimate a left outer join (SELECT VCHNUM,VCHDATE,SUM(is_number(replace(nvl(COL3,'0'),'-','0'))) AS COL3 from inspvch WHERE BRANCHCD='" + frm_mbr + "' and type='45' group by vchnum,vchdate) b on trim(a.vchnum)||to_char(a.vchdate,'dd/mm/yyyy')=trim(b.vchnum)||to_char(b.vchdate,'dd/mm/yyyy') where a.BRANCHCD='" + frm_mbr + "' and a.type='40' and a.enqdt " + DateRange + " group by a.enqno,a.enqdt,TRIM(a.aCODE),is_number(replace(nvl(a.COL3,'0'),'-','0')) ) group by enqno,enqdt,acode) A ";
        //mq1 = " ,COSTESTIMATE B,SOMAS C WHERE TRIM(A.ENQNO)||TO_CHAR(A.ENQDT,'DD/MM/YYYY')=TRIM(B.VCHNUM)||TO_CHAR(B.VCHDATE,'DD/MM/YYYY') AND TRIM(SUBSTR(B.CONVDATE,1,20))||TRIM(B.ACODE)||TRIM(B.ICODE)=C.BRANCHCD||C.TYPE||TRIM(C.ORDNO)||TO_CHAR(C.ORDDT,'DD/MM/YYYY')||TRIM(C.ACODE)||TRIM(C.ICODE) and b.BRANCHCD='" + frm_mbr + "' AND B.TYPE='30' AND B.SRNO=0) A,ITEM B,inspmst c,(SELECT SUM(A.MLT_LOSS) AS MLT_LOSS,SUM(A.MLT_LOSS1) AS MLT_LOSS1,SUM(A.MLT_LOSS2) AS MLT_LOSS2,sum(a.CORR_STG_REJ) AS CORR_STG_REJ,sum(a.snp) as snp,A.job_no,to_char(to_date(A.job_Dt,'dd/mm/yyyy'),'dd/mm/yyyy') as job_dt,A.icode FROM (select sum(A.mlt_loss) as mlt_loss,0 AS mlt_loss1,0 AS mlt_loss2 ,0  AS CORR_STG_REJ,0 as snp,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A ,TYPE B where A.BRANCHCD='" + frm_mbr + "' AND TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='09' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss, sum(A.mlt_loss) as mlt_loss1,0 AS mlt_loss2,0  AS CORR_STG_REJ,0 as snp ,A.job_no,A.job_Dt,TRIM(A.icode) AS ICODE from prod_sheet A,TYPE B where A.BRANCHCD='" + frm_mbr + "' AND TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='06' group by A.job_no,A.job_Dt,TRIM(A.ICODE) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,sum(A.mlt_loss) as mlt_loss2,0 AS CORR_STG_REJ,0 as snp ,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A,TYPE B where A.BRANCHCD='" + frm_mbr + "' AND TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='11' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,0 as mlt_loss2,sum(is_number(A.A4)) AS CORR_STG_REJ,0 as snp ,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A where a.type='88' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,0 as mlt_loss2,0 AS CORR_STG_REJ ,sum(is_number(a.col5)) as snp,A.enqno,to_char(a.enqdt,'dd/mm/yyyy'),TRIM(A.icode) AS icode from costestimate A where a.type='60' group by A.enqno,to_char(a.enqdt,'dd/mm/yyyy'),TRIM(A.icode)) A GROUP BY A.job_no,to_date(A.job_Dt,'dd/mm/yyyy'),A.icode) D WHERE TRIM(A.ACODE)=TRIM(B.ICODE) and trim(A.acode)=trim(c.icode) and trim(a.enqno)||to_char(a.enqdt,'dd/mm/yyyy')||trim(a.acode)=trim(D.job_no)||to_char(to_Date(D.job_Dt,'dd/mm/yyyy'),'dd/mm/yyyy')||trim(D.icode) and c.type='70' and c.srno=10 ORDER BY TO_CHAR(A.ENQDT,'YYYYmmdd') desc,a.enqno desc";
        // correction by yppl
        mq0 = "SELECT trim(a.enqno)||to_char(a.enqdt,'dd/mm/yyyy') as fstr,A.ENQNO AS JOBNO,TO_CHAR(A.ENQDT,'DD/MM/YYYY') AS JOBDT,A.ACODE AS ERPCODE,B.INAME AS PRODUCT,B.CPARTNO AS PARTNO,c.col15 as ply,A.COL13 as ups,A.TOT_BOX_RCV as TOT_BOX_REQ,a.STD_SHT_RQ as STD_SHT_RQ_WITH_WSTG, /* (a.STD_SHT_RQ*(is_number(c.col2)/1000)) AS std_MTR_reqd,*/ round(a.enr2/a.STD_SHT_RQ,4) AS STD_WT_PER_SHEET_per_JC,round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) AS STD_WT_PERBOX_per_JC,(CASE WHEN A.COL13>0 THEN round(A.QTYOUT/A.COL13,2) ELSE A.COL3 END) AS NO_OF_SHT_RCVD,A.QTYOUT AS BOX_to_be_PRODUCED,(CASE WHEN is_number(C.BTCHDT)>0 THEN ROUND((A.QTYOUT*is_number(C.BTCHDT))/100,2) ELSE 0 END) AS LINEAR_MTR_TO_BE_PROD,round(round(a.enr2/a.STD_SHT_RQ,4) * (CASE WHEN A.COL13>0 THEN round(A.QTYOUT/A.COL13,2) ELSE A.COL3 END),3) AS STD_WT_rQD_as_per_JC,A.QTYIN AS WT_CONSUME,a.scrp1 as gsm_var,a.scrp2 as fala,a.time1 as tore,a.time2 as core,(A.QTYIN - (round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ) /A.COL13,3)),3))) as CORR_STD_VS_ACT_wt_DIFF,d.CORR_STG_REJ,d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) as CORR_WT_LOSS,d.mlt_loss as print_stg_rej,(d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as prt_wt_loss,D.mlt_loss1 as gluing,(d.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as glu_wt_loss,d.snp as sorting_packing_rej,(d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4)) as  sorting_packing_loss , D.mlt_loss2 as other_S,(d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as oth_wt_loss, (  (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + (D.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3))) + (d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) + (d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4)) as paper_Wstg,round(d.CORR_STG_REJ+d.mlt_loss+D.mlt_loss1+d.snp+D.mlt_loss2,2) AS TOTL_REJN_NO,A.IQTYIN AS FINAL_BOX_PROD,round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4) as FINAL_BOX_PROD_WEIGHT,A.QTYIN - round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4) as WT_DIFF,ROUND((A.QTYIN - round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4)) / (CASE WHEN A.QTYIN>0 THEN A.QTYIN ELSE 1 END)  * 100 , 3) AS WT_WISE_REJ_PER,round(((A.QTYOUT - A.IQTYIN) / (case when A.QTYOUT>0 then a.qtyout else 1 end)) * 100,3) AS BOX_WISE_REJ,(CASE WHEN (A.QTYOUT-A.IQTYIN)<0 THEN ABS(A.QTYOUT-A.IQTYIN) ELSE 0 END) AS EXCESS,(CASE WHEN (A.QTYOUT-A.IQTYIN)>0 THEN ABS(A.QTYOUT-A.IQTYIN) ELSE 0 END) AS SHORTAGE,round((case when A.QTYIN>0 and a.val>0 then round(a.val/A.QTYIN,2) else 0 end),4) as matl_avg_rate, round( (A.QTYIN - (round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ) /A.COL13,3)),3))) + (  (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + (D.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3))) + (d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) + (d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4))) * round((case when A.QTYIN>0 and a.val>0 then round(a.val/A.QTYIN,2) else 0 end),4) as cost_of_wstg,(A.IQTYIN*A.SALERATE) as job_vALUE,A.VAL AS mat_cost, (case when (A.IQTYIN*A.SALERATE)>0 then round(((A.IQTYIN*A.SALERATE)-a.val) / (A.IQTYIN*A.SALERATE) ,3)*100 else 0 end ) as proft_per,round((A.IQTYIN*A.SALERATE)-a.val ,3) as profit_Value /*,ROUND((CASE WHEN A.TOT_BOX_RCV>0 THEN ((A.TOT_BOX_RCV-A.QTYOUT)/A.TOT_BOX_RCV)*100 ELSE 0 END),2)  as variation_per*/ FROM (SELECT A.*,B.QTY AS TOT_BOX_RCV,(B.COL14+B.COL15) AS STD_SHT_RQ,b.enr1,b.enr2,B.COL13,c.IRATE AS SALERATE FROM (select enqno,enqdt,acode,sum(qtyin) as qtyin,sum(qtyout) as qtyout,sum(scrp1) as scrp1,sum(scrp2) as scrp2,sum(time1) as time1,sum(time2) as time2,sum(COL3) as col3,SUM(IQTYIN) AS IQTYIN,SUM(VAL) AS VAL from (select INVNO AS ENQNO,INVDATE AS ENQDT,TRIM(ICODE) AS ACODE,0 as qtyin,0 as qtyout,0 AS COL3,0 as scrp1,0 as scrp2,0 as time1,0 as time2,SUM(IQTYIN) AS IQTYIN,0 AS VAL from IVOUCHER where BRANCHCD='" + frm_mbr + "' AND type='16' and INVDATE " + DateRange + " group by INVNO,INVDATE,TRIM(ICODE) union all select A.enqno,A.enqdt,TRIM(A.aCODE) AS ACODE,sum(A.itate) as qtyin,0 as qtyout,0 AS COL3,sum(A.scrp1) as scrp1,sum(A.scrp2) as scrp2,sum(A.time1) as time1,sum(A.time2) as time2,0 AS QTYIN1,SUM((case when b.irate>0 then ROUND(is_number(A.col4)*B.IRATE,2) else ROUND(is_number(A.col4)*c.IRATE,2) end)) AS VAL from item c,costestimate A left outer join REELVCH B on A.BRANCHCD||TRIM(A.ICODe)||TRIM(A.COL6)=B.BRANCHCD||TRIM(B.ICODe)||TRIM(B.KCLREELNO) and b.type in ('02','07','08','09') where trim(a.icode)=trim(c.icodE) and A.BRANCHCD='" + frm_mbr + "' AND A.type='25' and A.enqdt " + DateRange + " group by A.enqno,A.enqdt,TRIM(A.aCODE) union all select a.enqno,a.enqdt,TRIM(a.aCODE) AS ACODE,0 as qtyin,sum(a.qty + is_number(replace(nvl(b.COL3,'0'),'-','0')) ) as qtyout,is_number(replace(nvl(a.COL3,'0'),'-','0')) as col3,sum(a.scrp1) as scrp1,sum(a.scrp2) as scrp2,sum(a.time1) as time1,sum(a.time2) as time2,0 AS QTYIN1,0 AS VAL from costestimate a left outer join (SELECT VCHNUM,VCHDATE,SUM(is_number(replace(nvl(COL3,'0'),'-','0'))) AS COL3 from inspvch WHERE BRANCHCD='" + frm_mbr + "' and type='45' group by vchnum,vchdate) b on trim(a.vchnum)||to_char(a.vchdate,'dd/mm/yyyy')=trim(b.vchnum)||to_char(b.vchdate,'dd/mm/yyyy') where a.BRANCHCD='" + frm_mbr + "' and a.type='40' and a.enqdt " + DateRange + " group by a.enqno,a.enqdt,TRIM(a.aCODE),is_number(replace(nvl(a.COL3,'0'),'-','0')) ) group by enqno,enqdt,acode) A ";
        mq1 = " ,COSTESTIMATE B,SOMAS C WHERE TRIM(A.ENQNO)||TO_CHAR(A.ENQDT,'DD/MM/YYYY')=TRIM(B.VCHNUM)||TO_CHAR(B.VCHDATE,'DD/MM/YYYY') AND TRIM(SUBSTR(B.CONVDATE,1,20))||TRIM(B.ACODE)||TRIM(B.ICODE)=C.BRANCHCD||C.TYPE||TRIM(C.ORDNO)||TO_CHAR(C.ORDDT,'DD/MM/YYYY')||TRIM(C.ACODE)||TRIM(C.ICODE) and b.BRANCHCD='" + frm_mbr + "' AND B.TYPE='30' AND B.SRNO=0) A,ITEM B,inspmst c,(SELECT SUM(A.MLT_LOSS) AS MLT_LOSS,SUM(A.MLT_LOSS1) AS MLT_LOSS1,SUM(A.MLT_LOSS2) AS MLT_LOSS2,sum(a.CORR_STG_REJ) AS CORR_STG_REJ,sum(a.snp) as snp,A.job_no,to_char(to_date(A.job_Dt,'dd/mm/yyyy'),'dd/mm/yyyy') as job_dt,A.icode FROM (select sum(A.mlt_loss) as mlt_loss,0 AS mlt_loss1,0 AS mlt_loss2 ,0  AS CORR_STG_REJ,0 as snp,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A ,TYPE B where A.BRANCHCD='" + frm_mbr + "' AND TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='09' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss, sum(A.mlt_loss) as mlt_loss1,0 AS mlt_loss2,0  AS CORR_STG_REJ,0 as snp ,A.job_no,A.job_Dt,TRIM(A.icode) AS ICODE from prod_sheet A,TYPE B where A.BRANCHCD='" + frm_mbr + "' AND TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='06' group by A.job_no,A.job_Dt,TRIM(A.ICODE) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,sum(A.mlt_loss) as mlt_loss2,0 AS CORR_STG_REJ,0 as snp ,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A,TYPE B where A.BRANCHCD='" + frm_mbr + "' AND TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='11' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,0 as mlt_loss2,sum(is_number(A.A4)) AS CORR_STG_REJ,0 as snp ,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A where a.type='88' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,0 as mlt_loss2,0 AS CORR_STG_REJ ,sum(is_number(a.col5)) as snp,A.enqno,to_char(a.enqdt,'dd/mm/yyyy'),TRIM(A.icode) AS icode from costestimate A where a.type='60' group by A.enqno,to_char(a.enqdt,'dd/mm/yyyy'),TRIM(A.icode)) A GROUP BY A.job_no,to_date(A.job_Dt,'dd/mm/yyyy'),A.icode) D WHERE TRIM(A.ACODE)=TRIM(B.ICODE) and trim(A.acode)=trim(c.icode) and trim(a.enqno)||to_char(a.enqdt,'dd/mm/yyyy')||trim(a.acode)=trim(D.job_no)||to_char(to_Date(D.job_Dt,'dd/mm/yyyy'),'dd/mm/yyyy')||trim(D.icode) and c.type='70' and c.srno=10 ORDER BY TO_CHAR(A.ENQDT,'YYYYmmdd') desc,a.enqno desc";

        //CHANGE BY YOGITA ON 8/8/19 AS PER ASHOK SIR..ADD ONE NEW COLUMN AND CHANGE IN BOX_SIZE FORMULA
        //if (frm_cocd == "YPPL")
        {
            //  mq0 = "SELECT fstr,JOBNO,JOBDT,ERPCODE,PRODUCT,PARTNO,ply,ups,TOT_BOX_REQ,STD_SHT_RQ_WITH_WSTG,STD_WT_PER_SHEET_per_JC,STD_WT_PERBOX_per_JC,NO_OF_SHT_RCVD,BOX_to_be_PRODUCED, round(WT_CONSUME/ STD_WT_PERBOX_per_JC,3) AS Box_to_cal_as_per_wt_consumed, LINEAR_MTR_TO_BE_PROD ,STD_WT_rQD,WT_CONSUME,gsm_var,fala,tore,core,CORR_STD_VS_ACT_wt_DIFF,CORR_STG_REJ,CORR_WT_LOSS,print_stg_rej,prt_wt_loss,gluing,glu_wt_loss,sorting_packing_rej,sorting_packing_loss ,other_S,oth_wt_loss,paper_Wstg,TOTL_REJN_NO,FINAL_BOX_PROD,FINAL_BOX_PROD_WEIGHT,WT_DIFF ,WT_WISE_REJ_PER, ROUND(((round(WT_CONSUME/ STD_WT_PERBOX_per_JC,2)-round(FINAL_BOX_PROD,2))/round(WT_CONSUME/ STD_WT_PERBOX_per_JC,2))*100,3)  as BOX_WISE_REJ  ,EXCESS,SHORTAGE,matl_avg_rate,cost_of_wstg, job_vALUE, mat_cost, proft_per,profit_Value  FROM (SELECT trim(a.enqno)||to_char(a.enqdt,'dd/mm/yyyy') as fstr,A.ENQNO AS JOBNO,TO_CHAR(A.ENQDT,'DD/MM/YYYY') AS JOBDT,A.ACODE AS ERPCODE,B.INAME AS PRODUCT,B.CPARTNO AS PARTNO,c.col15 as ply,A.COL13 as ups,A.TOT_BOX_RCV as TOT_BOX_REQ,a.STD_SHT_RQ as STD_SHT_RQ_WITH_WSTG, /* (a.STD_SHT_RQ*(is_number(c.col2)/1000)) AS std_MTR_reqd,*/ round(a.enr2/a.STD_SHT_RQ,4) AS STD_WT_PER_SHEET_per_JC,round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) AS STD_WT_PERBOX_per_JC,(CASE WHEN A.COL13>0 THEN round(A.QTYOUT/A.COL13,2) ELSE A.COL3 END) AS NO_OF_SHT_RCVD,A.QTYOUT AS BOX_to_be_PRODUCED,(CASE WHEN is_number(C.BTCHDT)>0 THEN ROUND((A.QTYOUT*is_number(C.BTCHDT))/100,2) ELSE 0 END) AS LINEAR_MTR_TO_BE_PROD,round(round(a.enr2/a.STD_SHT_RQ,4) * (CASE WHEN A.COL13>0 THEN round(A.QTYOUT/A.COL13,2) ELSE A.COL3 END),3) AS STD_WT_rQD,A.QTYIN AS WT_CONSUME,a.scrp1 as gsm_var,a.scrp2 as fala,a.time1 as tore,a.time2 as core,(A.QTYIN - (round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ) /A.COL13,3)),3))) as CORR_STD_VS_ACT_wt_DIFF,d.CORR_STG_REJ,d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) as CORR_WT_LOSS,d.mlt_loss as print_stg_rej,(d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as prt_wt_loss,D.mlt_loss1 as gluing,(d.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as glu_wt_loss,d.snp as sorting_packing_rej,(d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4)) as  sorting_packing_loss , D.mlt_loss2 as other_S,(d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as oth_wt_loss, (  (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + (D.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3))) + (d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) + (d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4)) as paper_Wstg,round(d.CORR_STG_REJ+d.mlt_loss+D.mlt_loss1+d.snp+D.mlt_loss2,2) AS TOTL_REJN_NO,A.IQTYIN AS FINAL_BOX_PROD,round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4) as FINAL_BOX_PROD_WEIGHT,A.QTYIN - round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4) as WT_DIFF,ROUND((A.QTYIN - round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4)) / (CASE WHEN A.QTYIN>0 THEN A.QTYIN ELSE 1 END)  * 100 , 3) AS WT_WISE_REJ_PER,round(((A.QTYOUT - A.IQTYIN) / (case when A.QTYOUT>0 then a.qtyout else 1 end)) * 100,3) AS BOX_WISE_REJ,(CASE WHEN (A.QTYOUT-A.IQTYIN)<0 THEN ABS(A.QTYOUT-A.IQTYIN) ELSE 0 END) AS EXCESS,(CASE WHEN (A.QTYOUT-A.IQTYIN)>0 THEN ABS(A.QTYOUT-A.IQTYIN) ELSE 0 END) AS SHORTAGE,round((case when A.QTYIN>0 and a.val>0 then round(a.val/A.QTYIN,2) else 0 end),4) as matl_avg_rate, round( (A.QTYIN - (round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ) /A.COL13,3)),3))) + (  (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + (D.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3))) + (d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) + (d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4))) * round((case when A.QTYIN>0 and a.val>0 then round(a.val/A.QTYIN,2) else 0 end),4) as cost_of_wstg,(A.IQTYIN*A.SALERATE) as job_vALUE,A.VAL AS mat_cost, (case when (A.IQTYIN*A.SALERATE)>0 then round(((A.IQTYIN*A.SALERATE)-a.val) / (A.IQTYIN*A.SALERATE) ,3)*100 else 0 end ) as proft_per,round((A.IQTYIN*A.SALERATE)-a.val ,3) as profit_Value /*,ROUND((CASE WHEN A.TOT_BOX_RCV>0 THEN ((A.TOT_BOX_RCV-A.QTYOUT)/A.TOT_BOX_RCV)*100 ELSE 0 END),2)  as variation_per*/ FROM (SELECT A.*,B.QTY AS TOT_BOX_RCV,(B.COL14+B.COL15) AS STD_SHT_RQ,b.enr1,b.enr2,B.COL13,c.IRATE AS SALERATE FROM (select enqno,enqdt,acode,sum(qtyin) as qtyin,sum(qtyout) as qtyout,sum(scrp1) as scrp1,sum(scrp2) as scrp2,sum(time1) as time1,sum(time2) as time2,sum(COL3) as col3,SUM(IQTYIN) AS IQTYIN,SUM(VAL) AS VAL from (select INVNO AS ENQNO,INVDATE AS ENQDT,TRIM(ICODE) AS ACODE,0 as qtyin,0 as qtyout,0 AS COL3,0 as scrp1,0 as scrp2,0 as time1,0 as time2,SUM(IQTYIN) AS IQTYIN,0 AS VAL from IVOUCHER where BRANCHCD='" + frm_mbr + "' AND type='16' and INVDATE " + DateRange + " group by INVNO,INVDATE,TRIM(ICODE) union all select A.enqno,A.enqdt,TRIM(A.aCODE) AS ACODE,sum(A.itate) as qtyin,0 as qtyout,0 AS COL3,sum(A.scrp1) as scrp1,sum(A.scrp2) as scrp2,sum(A.time1) as time1,sum(A.time2) as time2,0 AS QTYIN1,SUM((case when b.irate>0 then ROUND(is_number(A.col4)*B.IRATE,2) else ROUND(is_number(A.col4)*c.IRATE,2) end)) AS VAL from item c,costestimate A left outer join REELVCH B on A.BRANCHCD||TRIM(A.ICODe)||TRIM(A.COL6)=B.BRANCHCD||TRIM(B.ICODe)||TRIM(B.KCLREELNO) and b.type in ('02','07') where trim(a.icode)=trim(c.icodE) and A.BRANCHCD='" + frm_mbr + "' AND A.type='25' and A.enqdt " + DateRange + " group by A.enqno,A.enqdt,TRIM(A.aCODE) union all select a.enqno,a.enqdt,TRIM(a.aCODE) AS ACODE,0 as qtyin,sum(a.qty + is_number(replace(nvl(b.COL3,'0'),'-','0')) ) as qtyout,is_number(replace(nvl(a.COL3,'0'),'-','0')) as col3,sum(a.scrp1) as scrp1,sum(a.scrp2) as scrp2,sum(a.time1) as time1,sum(a.time2) as time2,0 AS QTYIN1,0 AS VAL from costestimate a left outer join (SELECT VCHNUM,VCHDATE,SUM(is_number(replace(nvl(COL3,'0'),'-','0'))) AS COL3 from inspvch WHERE BRANCHCD='" + frm_mbr + "' and type='45' group by vchnum,vchdate) b on trim(a.vchnum)||to_char(a.vchdate,'dd/mm/yyyy')=trim(b.vchnum)||to_char(b.vchdate,'dd/mm/yyyy') where a.BRANCHCD='" + frm_mbr + "' and a.type='40' and a.enqdt " + DateRange + " group by a.enqno,a.enqdt,TRIM(a.aCODE),is_number(replace(nvl(a.COL3,'0'),'-','0')) ) group by enqno,enqdt,acode) A "; //REAL
            mq0 = "SELECT fstr,JOBNO,JOBDT,ERPCODE,PRODUCT,PARTNO,ply,ups,TOT_BOX_REQ,STD_SHT_RQ_WITH_WSTG,STD_WT_PER_SHEET_per_JC,STD_WT_PERBOX_per_JC,NO_OF_SHT_RCVD,BOX_to_be_PRODUCED, round((case when nvl(WT_CONSUME,0)=0 then 1 else nvl(WT_CONSUME,0) end)/ (case when nvl(STD_WT_PERBOX_per_JC,0)=0 then 1 else nvl(STD_WT_PERBOX_per_JC,0) end),3) AS Box_to_cal_as_per_wt_consumed, LINEAR_MTR_TO_BE_PROD ,STD_WT_rQD,WT_CONSUME,gsm_var,fala,tore,core,CORR_STD_VS_ACT_wt_DIFF,CORR_STG_REJ,CORR_WT_LOSS,print_stg_rej,prt_wt_loss,gluing,glu_wt_loss,sorting_packing_rej,sorting_packing_loss ,other_S,oth_wt_loss,paper_Wstg,TOTL_REJN_NO,FINAL_BOX_PROD,FINAL_BOX_PROD_WEIGHT,WT_DIFF ,WT_WISE_REJ_PER, ROUND(((round(WT_CONSUME/ STD_WT_PERBOX_per_JC,2)-round(FINAL_BOX_PROD,2))/round((case when nvl(WT_CONSUME,0)=0 then 1 else nvl(WT_CONSUME,0) end)/(case when nvl(STD_WT_PERBOX_per_JC,0)=0 then 1 else nvl(STD_WT_PERBOX_per_JC,0) end),2))*100,3)  as BOX_WISE_REJ  ,EXCESS,SHORTAGE,matl_avg_rate,cost_of_wstg, job_vALUE, mat_cost, proft_per,profit_Value  FROM (SELECT trim(a.enqno)||to_char(a.enqdt,'dd/mm/yyyy') as fstr,A.ENQNO AS JOBNO,TO_CHAR(A.ENQDT,'DD/MM/YYYY') AS JOBDT,A.ACODE AS ERPCODE,B.INAME AS PRODUCT,B.CPARTNO AS PARTNO,c.col15 as ply,A.COL13 as ups,A.TOT_BOX_RCV as TOT_BOX_REQ,a.STD_SHT_RQ as STD_SHT_RQ_WITH_WSTG, /* (a.STD_SHT_RQ*(is_number(c.col2)/1000)) AS std_MTR_reqd,*/ round(a.enr2/a.STD_SHT_RQ,4) AS STD_WT_PER_SHEET_per_JC,round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) AS STD_WT_PERBOX_per_JC,(CASE WHEN A.COL13>0 THEN round(A.QTYOUT/A.COL13,2) ELSE A.COL3 END) AS NO_OF_SHT_RCVD,A.QTYOUT AS BOX_to_be_PRODUCED,(CASE WHEN is_number(C.BTCHDT)>0 THEN ROUND((A.QTYOUT*is_number(C.BTCHDT))/100,2) ELSE 0 END) AS LINEAR_MTR_TO_BE_PROD,round(round(a.enr2/a.STD_SHT_RQ,4) * (CASE WHEN A.COL13>0 THEN round(A.QTYOUT/A.COL13,2) ELSE A.COL3 END),3) AS STD_WT_rQD,A.QTYIN AS WT_CONSUME,a.scrp1 as gsm_var,a.scrp2 as fala,a.time1 as tore,a.time2 as core,(A.QTYIN - (round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ) /A.COL13,3)),3))) as CORR_STD_VS_ACT_wt_DIFF,d.CORR_STG_REJ,d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) as CORR_WT_LOSS,d.mlt_loss as print_stg_rej,(d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as prt_wt_loss,D.mlt_loss1 as gluing,(d.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as glu_wt_loss,d.snp as sorting_packing_rej,(d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4)) as  sorting_packing_loss , D.mlt_loss2 as other_S,(d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as oth_wt_loss, (  (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + (D.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3))) + (d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) + (d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4)) as paper_Wstg,round(d.CORR_STG_REJ+d.mlt_loss+D.mlt_loss1+d.snp+D.mlt_loss2,2) AS TOTL_REJN_NO,A.IQTYIN AS FINAL_BOX_PROD,round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4) as FINAL_BOX_PROD_WEIGHT,A.QTYIN - round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4) as WT_DIFF,ROUND((A.QTYIN - round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4)) / (CASE WHEN A.QTYIN>0 THEN A.QTYIN ELSE 1 END)  * 100 , 3) AS WT_WISE_REJ_PER,round(((A.QTYOUT - A.IQTYIN) / (case when A.QTYOUT>0 then a.qtyout else 1 end)) * 100,3) AS BOX_WISE_REJ,(CASE WHEN (A.QTYOUT-A.IQTYIN)<0 THEN ABS(A.QTYOUT-A.IQTYIN) ELSE 0 END) AS EXCESS,(CASE WHEN (A.QTYOUT-A.IQTYIN)>0 THEN ABS(A.QTYOUT-A.IQTYIN) ELSE 0 END) AS SHORTAGE,round((case when A.QTYIN>0 and a.val>0 then round(a.val/A.QTYIN,2) else 0 end),4) as matl_avg_rate, round( (A.QTYIN - (round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ) /A.COL13,3)),3))) + (  (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + (D.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3))) + (d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) + (d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4))) * round((case when A.QTYIN>0 and a.val>0 then round(a.val/A.QTYIN,2) else 0 end),4) as cost_of_wstg,(A.IQTYIN*A.SALERATE) as job_vALUE,A.VAL AS mat_cost, (case when (A.IQTYIN*A.SALERATE)>0 then round(((A.IQTYIN*A.SALERATE)-a.val) / (A.IQTYIN*A.SALERATE) ,3)*100 else 0 end ) as proft_per,round((A.IQTYIN*A.SALERATE)-a.val ,3) as profit_Value /*,ROUND((CASE WHEN A.TOT_BOX_RCV>0 THEN ((A.TOT_BOX_RCV-A.QTYOUT)/A.TOT_BOX_RCV)*100 ELSE 0 END),2)  as variation_per*/ FROM (SELECT A.*,B.QTY AS TOT_BOX_RCV,(B.COL14+B.COL15) AS STD_SHT_RQ,b.enr1,b.enr2,B.COL13,c.IRATE AS SALERATE FROM (select enqno,enqdt,acode,sum(qtyin) as qtyin,sum(qtyout) as qtyout,sum(scrp1) as scrp1,sum(scrp2) as scrp2,sum(time1) as time1,sum(time2) as time2,sum(COL3) as col3,SUM(IQTYIN) AS IQTYIN,SUM(VAL) AS VAL from (select INVNO AS ENQNO,INVDATE AS ENQDT,TRIM(ICODE) AS ACODE,0 as qtyin,0 as qtyout,0 AS COL3,0 as scrp1,0 as scrp2,0 as time1,0 as time2,SUM(IQTYIN) AS IQTYIN,0 AS VAL from IVOUCHER where BRANCHCD='" + frm_mbr + "' AND type='16' and INVDATE " + DateRange + " group by INVNO,INVDATE,TRIM(ICODE) union all select A.enqno,A.enqdt,TRIM(A.aCODE) AS ACODE,sum(A.itate) as qtyin,0 as qtyout,0 AS COL3,sum(A.scrp1) as scrp1,sum(A.scrp2) as scrp2,sum(A.time1) as time1,sum(A.time2) as time2,0 AS QTYIN1,SUM((case when b.irate>0 then ROUND(is_number(A.col4)*B.IRATE,2) else ROUND(is_number(A.col4)*c.IRATE,2) end)) AS VAL from item c,costestimate A left outer join REELVCH B on A.BRANCHCD||TRIM(A.ICODe)||TRIM(A.COL6)=B.BRANCHCD||TRIM(B.ICODe)||TRIM(B.KCLREELNO) and b.type in ('02','07','08','09') where trim(a.icode)=trim(c.icodE) and A.BRANCHCD='" + frm_mbr + "' AND A.type='25' and A.enqdt " + DateRange + " group by A.enqno,A.enqdt,TRIM(A.aCODE) union all select a.enqno,a.enqdt,TRIM(a.aCODE) AS ACODE,0 as qtyin,sum(a.qty + is_number(replace(nvl(b.COL3,'0'),'-','0')) ) as qtyout,is_number(replace(nvl(a.COL3,'0'),'-','0')) as col3,sum(a.scrp1) as scrp1,sum(a.scrp2) as scrp2,sum(a.time1) as time1,sum(a.time2) as time2,0 AS QTYIN1,0 AS VAL from costestimate a left outer join (SELECT VCHNUM,VCHDATE,SUM(is_number(replace(nvl(COL3,'0'),'-','0'))) AS COL3 from inspvch WHERE BRANCHCD='" + frm_mbr + "' and type='45' group by vchnum,vchdate) b on trim(a.vchnum)||to_char(a.vchdate,'dd/mm/yyyy')=trim(b.vchnum)||to_char(b.vchdate,'dd/mm/yyyy') where a.BRANCHCD='" + frm_mbr + "' and a.type='40' and a.enqdt " + DateRange + " group by a.enqno,a.enqdt,TRIM(a.aCODE),is_number(replace(nvl(a.COL3,'0'),'-','0')) ) group by enqno,enqdt,acode) A "; //REAL
            mq1 = " ,COSTESTIMATE B,SOMAS C WHERE TRIM(A.ENQNO)||TO_CHAR(A.ENQDT,'DD/MM/YYYY')=TRIM(B.VCHNUM)||TO_CHAR(B.VCHDATE,'DD/MM/YYYY') AND TRIM(SUBSTR(B.CONVDATE,1,20))||TRIM(B.ACODE)||TRIM(B.ICODE)=C.BRANCHCD||C.TYPE||TRIM(C.ORDNO)||TO_CHAR(C.ORDDT,'DD/MM/YYYY')||TRIM(C.ACODE)||TRIM(C.ICODE) and b.BRANCHCD='" + frm_mbr + "' AND B.TYPE='30' AND B.SRNO=0) A,ITEM B,inspmst c,(SELECT SUM(A.MLT_LOSS) AS MLT_LOSS,SUM(A.MLT_LOSS1) AS MLT_LOSS1,SUM(A.MLT_LOSS2) AS MLT_LOSS2,sum(a.CORR_STG_REJ) AS CORR_STG_REJ,sum(a.snp) as snp,A.job_no,to_char(to_date(A.job_Dt,'dd/mm/yyyy'),'dd/mm/yyyy') as job_dt,A.icode FROM (select sum(A.mlt_loss) as mlt_loss,0 AS mlt_loss1,0 AS mlt_loss2 ,0  AS CORR_STG_REJ,0 as snp,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A ,TYPE B where A.BRANCHCD='" + frm_mbr + "' AND TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='09' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss, sum(A.mlt_loss) as mlt_loss1,0 AS mlt_loss2,0  AS CORR_STG_REJ,0 as snp ,A.job_no,A.job_Dt,TRIM(A.icode) AS ICODE from prod_sheet A,TYPE B where A.BRANCHCD='" + frm_mbr + "' AND TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='06' group by A.job_no,A.job_Dt,TRIM(A.ICODE) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,sum(A.mlt_loss) as mlt_loss2,0 AS CORR_STG_REJ,0 as snp ,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A,TYPE B where A.BRANCHCD='" + frm_mbr + "' AND TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='11' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,0 as mlt_loss2,sum(is_number(A.A4)) AS CORR_STG_REJ,0 as snp ,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A where a.type='88' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,0 as mlt_loss2,0 AS CORR_STG_REJ ,sum(is_number(a.col5)) as snp,A.enqno,to_char(a.enqdt,'dd/mm/yyyy'),TRIM(A.icode) AS icode from costestimate A where a.type='60' group by A.enqno,to_char(a.enqdt,'dd/mm/yyyy'),TRIM(A.icode)) A GROUP BY A.job_no,to_date(A.job_Dt,'dd/mm/yyyy'),A.icode) D WHERE TRIM(A.ACODE)=TRIM(B.ICODE) and trim(A.acode)=trim(c.icode) and trim(a.enqno)||to_char(a.enqdt,'dd/mm/yyyy')||trim(a.acode)=trim(D.job_no)||to_char(to_Date(D.job_Dt,'dd/mm/yyyy'),'dd/mm/yyyy')||trim(D.icode) and c.type='70' and c.srno=10 ORDER BY TO_CHAR(A.ENQDT,'YYYYmmdd') desc,a.enqno desc)";

            // DATE RANGE IS REMOVED FROM REELVCH,REELVCH_OP BECUASE SOME OF THE REELS WERE NOT COMING DUE TO DATE RANGE ON 07 MARCH 2020 BY MADHVI
            mq0 = "SELECT fstr,JOBNO,JOBDT,ERPCODE,PRODUCT,PARTNO,ply,ups,TOT_BOX_REQ,STD_SHT_RQ_WITH_WSTG,STD_WT_PER_SHEET_per_JC,STD_WT_PERBOX_per_JC,NO_OF_SHT_RCVD,BOX_to_be_PRODUCED, round((case when nvl(WT_CONSUME,0)=0 then 1 else nvl(WT_CONSUME,0) end)/ (case when nvl(STD_WT_PERBOX_per_JC,0)=0 then 1 else nvl(STD_WT_PERBOX_per_JC,0) end),3) AS Box_to_cal_as_per_wt_consumed, LINEAR_MTR_TO_BE_PROD ,STD_WT_rQD,WT_CONSUME,gsm_var,fala,tore,core,CORR_STD_VS_ACT_wt_DIFF,CORR_STG_REJ,CORR_WT_LOSS,print_stg_rej,prt_wt_loss,gluing,glu_wt_loss,sorting_packing_rej,sorting_packing_loss ,other_S,oth_wt_loss,paper_Wstg,TOTL_REJN_NO,FINAL_BOX_PROD,FINAL_BOX_PROD_WEIGHT,WT_DIFF ,WT_WISE_REJ_PER,ROUND(((round((case when nvl(WT_CONSUME,0)=0 then 1 else nvl(WT_CONSUME,0) end)/ (case when is_number(STD_WT_PERBOX_per_JC)>0 then STD_WT_PERBOX_per_JC else 1 end ),2)-round((case when nvl(FINAL_BOX_PROD,0)=0 then 1 else nvl(FINAL_BOX_PROD,0) end),2))/round((case when nvl(WT_CONSUME,0)=0 then 1 else nvl(WT_CONSUME,0) end)/(case when is_number(STD_WT_PERBOX_per_JC)>0 then STD_WT_PERBOX_per_JC else 1 end),2))*100,3)  as BOX_WISE_REJ  ,EXCESS,SHORTAGE,matl_avg_rate,cost_of_wstg, job_vALUE, mat_cost, proft_per,profit_Value  FROM (SELECT trim(a.enqno)||to_char(a.enqdt,'dd/mm/yyyy') as fstr,A.ENQNO AS JOBNO,TO_CHAR(A.ENQDT,'DD/MM/YYYY') AS JOBDT,A.ACODE AS ERPCODE,B.INAME AS PRODUCT,B.CPARTNO AS PARTNO,c.col15 as ply,A.COL13 as ups,A.TOT_BOX_RCV as TOT_BOX_REQ,a.STD_SHT_RQ as STD_SHT_RQ_WITH_WSTG, /* (a.STD_SHT_RQ*(is_number(c.col2)/1000)) AS std_MTR_reqd,*/ round(a.enr2/a.STD_SHT_RQ,4) AS STD_WT_PER_SHEET_per_JC,round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) AS STD_WT_PERBOX_per_JC,(CASE WHEN A.COL13>0 THEN round(A.QTYOUT/A.COL13,2) ELSE A.COL3 END) AS NO_OF_SHT_RCVD,A.QTYOUT AS BOX_to_be_PRODUCED,(CASE WHEN is_number(C.BTCHDT)>0 THEN ROUND((A.QTYOUT*is_number(C.BTCHDT))/100,2) ELSE 0 END) AS LINEAR_MTR_TO_BE_PROD,round(round(a.enr2/a.STD_SHT_RQ,4) * (CASE WHEN A.COL13>0 THEN round(A.QTYOUT/A.COL13,2) ELSE A.COL3 END),3) AS STD_WT_rQD,A.QTYIN AS WT_CONSUME,a.scrp1 as gsm_var,a.scrp2 as fala,a.time1 as tore,a.time2 as core,(A.QTYIN - (round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ) /A.COL13,3)),3))) as CORR_STD_VS_ACT_wt_DIFF,d.CORR_STG_REJ,d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) as CORR_WT_LOSS,d.mlt_loss as print_stg_rej,(d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as prt_wt_loss,D.mlt_loss1 as gluing,(d.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as glu_wt_loss,d.snp as sorting_packing_rej,(d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4)) as  sorting_packing_loss , D.mlt_loss2 as other_S,(d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as oth_wt_loss, (  (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + (D.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3))) + (d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) + (d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4)) as paper_Wstg,round(d.CORR_STG_REJ+d.mlt_loss+D.mlt_loss1+d.snp+D.mlt_loss2,2) AS TOTL_REJN_NO,A.IQTYIN AS FINAL_BOX_PROD,round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4) as FINAL_BOX_PROD_WEIGHT,A.QTYIN - round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4) as WT_DIFF,ROUND((A.QTYIN - round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4)) / (CASE WHEN A.QTYIN>0 THEN A.QTYIN ELSE 1 END)  * 100 , 3) AS WT_WISE_REJ_PER,round(((A.QTYOUT - A.IQTYIN) / (case when A.QTYOUT>0 then a.qtyout else 1 end)) * 100,3) AS BOX_WISE_REJ,(CASE WHEN (A.QTYOUT-A.IQTYIN)<0 THEN ABS(A.QTYOUT-A.IQTYIN) ELSE 0 END) AS EXCESS,(CASE WHEN (A.QTYOUT-A.IQTYIN)>0 THEN ABS(A.QTYOUT-A.IQTYIN) ELSE 0 END) AS SHORTAGE,round((case when A.QTYIN>0 and a.val>0 then round(a.val/A.QTYIN,2) else 0 end),4) as matl_avg_rate, round( (A.QTYIN - (round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ) /A.COL13,3)),3))) + (  (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + (D.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3))) + (d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) + (d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4))) * round((case when A.QTYIN>0 and a.val>0 then round(a.val/A.QTYIN,2) else 0 end),4) as cost_of_wstg,(A.IQTYIN*A.SALERATE) as job_vALUE,A.VAL AS mat_cost, (case when (A.IQTYIN*A.SALERATE)>0 then round(((A.IQTYIN*A.SALERATE)-a.val) / (A.IQTYIN*A.SALERATE) ,3)*100 else 0 end ) as proft_per,round((A.IQTYIN*A.SALERATE)-a.val ,3) as profit_Value /*,ROUND((CASE WHEN A.TOT_BOX_RCV>0 THEN ((A.TOT_BOX_RCV-A.QTYOUT)/A.TOT_BOX_RCV)*100 ELSE 0 END),2)  as variation_per*/ FROM (SELECT A.*,B.QTY AS TOT_BOX_RCV,(B.COL14+B.COL15) AS STD_SHT_RQ,b.enr1,b.enr2,B.COL13,c.IRATE AS SALERATE FROM (select enqno,enqdt,acode,sum(qtyin) as qtyin,sum(qtyout) as qtyout,sum(scrp1) as scrp1,sum(scrp2) as scrp2,sum(time1) as time1,sum(time2) as time2,sum(COL3) as col3,SUM(IQTYIN) AS IQTYIN,SUM(VAL) AS VAL from (select INVNO AS ENQNO,INVDATE AS ENQDT,TRIM(ICODE) AS ACODE,0 as qtyin,0 as qtyout,0 AS COL3,0 as scrp1,0 as scrp2,0 as time1,0 as time2,SUM(IQTYIN) AS IQTYIN,0 AS VAL from IVOUCHER where BRANCHCD='" + frm_mbr + "' AND type='16' and INVDATE " + DateRange + " group by INVNO,INVDATE,TRIM(ICODE) union all select A.enqno,A.enqdt,TRIM(A.aCODE) AS ACODE,sum(A.itate) as qtyin,0 as qtyout,0 AS COL3,sum(A.scrp1) as scrp1,sum(A.scrp2) as scrp2,sum(A.time1) as time1,sum(A.time2) as time2,0 AS QTYIN1,SUM((case when b.irate>0 then ROUND(is_number(A.col4)*B.IRATE,2) else ROUND(is_number(A.col4)*c.IRATE,2) end)) AS VAL from item c,costestimate A left outer join (SELECT ICODE,KCLREELNO,IRATE,BRANCHCD,TYPE FROM REELVCH WHERE BRANCHCD='" + frm_mbr + "' AND TYPE like '0%' /*AND VCHDATE " + xprdRange + "*/ UNION ALL SELECT ICODE,KCLREELNO,IRATE,BRANCHCD,TYPE FROM REELVCH_OP WHERE BRANCHCD='" + frm_mbr + "' AND TYPE like '0%' /*AND VCHDATE " + xprdRange + "*/) B on A.BRANCHCD||TRIM(A.ICODe)||TRIM(A.COL6)=B.BRANCHCD||TRIM(B.ICODe)||TRIM(B.KCLREELNO) and b.type like '0%' where trim(a.icode)=trim(c.icodE) and A.BRANCHCD='" + frm_mbr + "' AND A.type='25' and A.enqdt " + DateRange + " group by A.enqno,A.enqdt,TRIM(A.aCODE) union all select a.enqno,a.enqdt,TRIM(a.aCODE) AS ACODE,0 as qtyin,sum(a.qty + is_number(replace(nvl(b.COL3,'0'),'-','0')) ) as qtyout,is_number(replace(nvl(a.COL3,'0'),'-','0')) as col3,sum(a.scrp1) as scrp1,sum(a.scrp2) as scrp2,sum(a.time1) as time1,sum(a.time2) as time2,0 AS QTYIN1,0 AS VAL from costestimate a left outer join (SELECT VCHNUM,VCHDATE,SUM(is_number(replace(nvl(COL3,'0'),'-','0'))) AS COL3 from inspvch WHERE BRANCHCD='" + frm_mbr + "' and type='45' group by vchnum,vchdate) b on trim(a.vchnum)||to_char(a.vchdate,'dd/mm/yyyy')=trim(b.vchnum)||to_char(b.vchdate,'dd/mm/yyyy') where a.BRANCHCD='" + frm_mbr + "' and a.type='40' and a.enqdt " + DateRange + " group by a.enqno,a.enqdt,TRIM(a.aCODE),is_number(replace(nvl(a.COL3,'0'),'-','0')) ) group by enqno,enqdt,acode) A "; //REAL
            mq1 = " ,COSTESTIMATE B,SOMAS C WHERE TRIM(A.ENQNO)||TO_CHAR(A.ENQDT,'DD/MM/YYYY')=TRIM(B.VCHNUM)||TO_CHAR(B.VCHDATE,'DD/MM/YYYY') AND TRIM(SUBSTR(B.CONVDATE,1,20))||TRIM(B.ACODE)||TRIM(B.ICODE)=C.BRANCHCD||C.TYPE||TRIM(C.ORDNO)||TO_CHAR(C.ORDDT,'DD/MM/YYYY')||TRIM(C.ACODE)||TRIM(C.ICODE) and b.BRANCHCD='" + frm_mbr + "' AND B.TYPE='30' AND B.SRNO=0) A,ITEM B,inspmst c,(SELECT SUM(A.MLT_LOSS) AS MLT_LOSS,SUM(A.MLT_LOSS1) AS MLT_LOSS1,SUM(A.MLT_LOSS2) AS MLT_LOSS2,sum(a.CORR_STG_REJ) AS CORR_STG_REJ,sum(a.snp) as snp,A.job_no,to_char(to_date(A.job_Dt,'dd/mm/yyyy'),'dd/mm/yyyy') as job_dt,A.icode FROM (select sum(A.mlt_loss) as mlt_loss,0 AS mlt_loss1,0 AS mlt_loss2 ,0  AS CORR_STG_REJ,0 as snp,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A ,TYPE B where A.BRANCHCD='" + frm_mbr + "' AND TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='09' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss, sum(A.mlt_loss) as mlt_loss1,0 AS mlt_loss2,0  AS CORR_STG_REJ,0 as snp ,A.job_no,A.job_Dt,TRIM(A.icode) AS ICODE from prod_sheet A,TYPE B where A.BRANCHCD='" + frm_mbr + "' AND TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='06' group by A.job_no,A.job_Dt,TRIM(A.ICODE) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,sum(A.mlt_loss) as mlt_loss2,0 AS CORR_STG_REJ,0 as snp ,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A,TYPE B where A.BRANCHCD='" + frm_mbr + "' AND TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='11' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,0 as mlt_loss2,sum(is_number(A.A4)) AS CORR_STG_REJ,0 as snp ,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A where a.type='88' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,0 as mlt_loss2,0 AS CORR_STG_REJ ,sum(is_number(a.col5)) as snp,A.enqno,to_char(a.enqdt,'dd/mm/yyyy'),TRIM(A.icode) AS icode from costestimate A where a.type='60' group by A.enqno,to_char(a.enqdt,'dd/mm/yyyy'),TRIM(A.icode)) A GROUP BY A.job_no,to_date(A.job_Dt,'dd/mm/yyyy'),A.icode) D WHERE TRIM(A.ACODE)=TRIM(B.ICODE) and trim(A.acode)=trim(c.icode) and trim(a.enqno)||to_char(a.enqdt,'dd/mm/yyyy')||trim(a.acode)=trim(D.job_no)||to_char(to_Date(D.job_Dt,'dd/mm/yyyy'),'dd/mm/yyyy')||trim(D.icode) and c.type='70' and c.srno=10 ORDER BY TO_CHAR(A.ENQDT,'YYYYmmdd') desc,a.enqno desc)";

            if (frm_cocd == "IPP")
            {
                mq0 = "SELECT fstr,JOBNO,JOBDT,ERPCODE,PRODUCT,PARTNO,ply,ups,TOT_BOX_REQ,STD_SHT_RQ_WITH_WSTG,STD_WT_PER_SHEET_per_JC,STD_WT_PERBOX_per_JC,NO_OF_SHT_RCVD,BOX_to_be_PRODUCED, round((case when nvl(WT_CONSUME,0)=0 then 1 else nvl(WT_CONSUME,0) end)/ (case when nvl(STD_WT_PERBOX_per_JC,0)=0 then 1 else nvl(STD_WT_PERBOX_per_JC,0) end),3) AS Box_to_cal_as_per_wt_consumed, LINEAR_MTR_TO_BE_PROD ,STD_WT_rQD,WT_CONSUME,gsm_var,fala,tore,core,CORR_STD_VS_ACT_wt_DIFF,CORR_STG_REJ,CORR_WT_LOSS,print_stg_rej,prt_wt_loss,gluing,glu_wt_loss,sorting_packing_rej,sorting_packing_loss ,other_S,oth_wt_loss,paper_Wstg,TOTL_REJN_NO,FINAL_BOX_PROD,FINAL_BOX_PROD_WEIGHT,WT_DIFF ,WT_WISE_REJ_PER,ROUND(((round((case when nvl(WT_CONSUME,0)=0 then 1 else nvl(WT_CONSUME,0) end)/ (case when is_number(STD_WT_PERBOX_per_JC)>0 then STD_WT_PERBOX_per_JC else 1 end ),2)-round((case when nvl(FINAL_BOX_PROD,0)=0 then 1 else nvl(FINAL_BOX_PROD,0) end),2))/round((case when nvl(WT_CONSUME,0)=0 then 1 else nvl(WT_CONSUME,0) end)/(case when is_number(STD_WT_PERBOX_per_JC)>0 then STD_WT_PERBOX_per_JC else 1 end),2))*100,3)  as BOX_WISE_REJ  ,EXCESS,SHORTAGE,matl_avg_rate,cost_of_wstg, job_vALUE, mat_cost, proft_per,profit_Value  FROM (SELECT trim(a.enqno)||to_char(a.enqdt,'dd/mm/yyyy') as fstr,A.ENQNO AS JOBNO,TO_CHAR(A.ENQDT,'DD/MM/YYYY') AS JOBDT,A.ACODE AS ERPCODE,B.INAME AS PRODUCT,B.CPARTNO AS PARTNO,c.col15 as ply,A.COL13 as ups,A.TOT_BOX_RCV as TOT_BOX_REQ,a.STD_SHT_RQ as STD_SHT_RQ_WITH_WSTG, /* (a.STD_SHT_RQ*(is_number(c.col2)/1000)) AS std_MTR_reqd,*/ round(a.enr2/a.STD_SHT_RQ,4) AS STD_WT_PER_SHEET_per_JC,round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) AS STD_WT_PERBOX_per_JC,(CASE WHEN A.COL13>0 THEN round(A.QTYOUT/A.COL13,2) ELSE A.COL3 END) AS NO_OF_SHT_RCVD,A.QTYOUT AS BOX_to_be_PRODUCED,(CASE WHEN IS_NUMBER(A.COL13) >1 THEN (CASE WHEN is_number(A.COL19)>0 THEN ROUND((A.QTYOUT*is_number(A.COL19))/100,2) ELSE 0 END) ELSE (CASE WHEN A.COL13>0 AND is_number(A.COL19)>0 THEN ROUND((round(A.QTYOUT/A.COL13,2) *is_number(A.COL19))/100,2) ELSE 0 END) END) AS LINEAR_MTR_TO_BE_PROD,round(round(a.enr2/a.STD_SHT_RQ,4) * (CASE WHEN A.COL13>0 THEN round(A.QTYOUT/A.COL13,2) ELSE A.COL3 END),3) AS STD_WT_rQD,A.QTYIN AS WT_CONSUME,a.scrp1 as gsm_var,a.scrp2 as fala,a.time1 as tore,a.time2 as core,(A.QTYIN - (round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ) /A.COL13,3)),3))) as CORR_STD_VS_ACT_wt_DIFF,d.CORR_STG_REJ,d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) as CORR_WT_LOSS,d.mlt_loss as print_stg_rej,(d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as prt_wt_loss,D.mlt_loss1 as gluing,(d.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as glu_wt_loss,d.snp as sorting_packing_rej,(d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4)) as  sorting_packing_loss , D.mlt_loss2 as other_S,(d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as oth_wt_loss, (  (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + (D.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3))) + (d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) + (d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4)) as paper_Wstg,round(d.CORR_STG_REJ+d.mlt_loss+D.mlt_loss1+d.snp+D.mlt_loss2,2) AS TOTL_REJN_NO,A.IQTYIN AS FINAL_BOX_PROD,round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4) as FINAL_BOX_PROD_WEIGHT,A.QTYIN - round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4) as WT_DIFF,ROUND((A.QTYIN - round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4)) / (CASE WHEN A.QTYIN>0 THEN A.QTYIN ELSE 1 END)  * 100 , 3) AS WT_WISE_REJ_PER,round(((A.QTYOUT - A.IQTYIN) / (case when A.QTYOUT>0 then a.qtyout else 1 end)) * 100,3) AS BOX_WISE_REJ,(CASE WHEN (A.QTYOUT-A.IQTYIN)<0 THEN ABS(A.QTYOUT-A.IQTYIN) ELSE 0 END) AS EXCESS,(CASE WHEN (A.QTYOUT-A.IQTYIN)>0 THEN ABS(A.QTYOUT-A.IQTYIN) ELSE 0 END) AS SHORTAGE,round((case when A.QTYIN>0 and a.val>0 then round(a.val/A.QTYIN,2) else 0 end),4) as matl_avg_rate, round( (A.QTYIN - (round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ) /A.COL13,3)),3))) + (  (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + (D.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3))) + (d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) + (d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4))) * round((case when A.QTYIN>0 and a.val>0 then round(a.val/A.QTYIN,2) else 0 end),4) as cost_of_wstg,(A.IQTYIN*A.SALERATE) as job_vALUE,A.VAL AS mat_cost, (case when (A.IQTYIN*A.SALERATE)>0 then round(((A.IQTYIN*A.SALERATE)-a.val) / (A.IQTYIN*A.SALERATE) ,3)*100 else 0 end ) as proft_per,round((A.IQTYIN*A.SALERATE)-a.val ,3) as profit_Value /*,ROUND((CASE WHEN A.TOT_BOX_RCV>0 THEN ((A.TOT_BOX_RCV-A.QTYOUT)/A.TOT_BOX_RCV)*100 ELSE 0 END),2)  as variation_per*/ FROM (SELECT A.*,B.COL19,B.QTY AS TOT_BOX_RCV,(B.COL14+B.COL15) AS STD_SHT_RQ,b.enr1,b.enr2,B.COL13,c.IRATE AS SALERATE FROM (select enqno,enqdt,acode,sum(qtyin) as qtyin,sum(qtyout) as qtyout,sum(scrp1) as scrp1,sum(scrp2) as scrp2,sum(time1) as time1,sum(time2) as time2,sum(COL3) as col3,SUM(IQTYIN) AS IQTYIN,SUM(VAL) AS VAL from (select INVNO AS ENQNO,INVDATE AS ENQDT,TRIM(ICODE) AS ACODE,0 as qtyin,0 as qtyout,0 AS COL3,0 as scrp1,0 as scrp2,0 as time1,0 as time2,SUM(IQTYIN) AS IQTYIN,0 AS VAL from IVOUCHER where BRANCHCD='" + frm_mbr + "' AND type='16' and INVDATE " + DateRange + " group by INVNO,INVDATE,TRIM(ICODE) union all select A.enqno,A.enqdt,TRIM(A.aCODE) AS ACODE,sum(A.itate) as qtyin,0 as qtyout,0 AS COL3,sum(A.scrp1) as scrp1,sum(A.scrp2) as scrp2,sum(A.time1) as time1,sum(A.time2) as time2,0 AS QTYIN1,SUM((case when b.irate>0 then ROUND(is_number(A.col4)*B.IRATE,2) else ROUND(is_number(A.col4)*c.IRATE,2) end)) AS VAL from item c,costestimate A left outer join (SELECT ICODE,KCLREELNO,IRATE,BRANCHCD,TYPE FROM REELVCH WHERE BRANCHCD='" + frm_mbr + "' AND TYPE like '0%' /*AND VCHDATE " + xprdRange + "*/ UNION ALL SELECT ICODE,KCLREELNO,IRATE,BRANCHCD,TYPE FROM REELVCH_OP WHERE BRANCHCD='" + frm_mbr + "' AND TYPE like '0%' /*AND VCHDATE " + xprdRange + "*/) B on A.BRANCHCD||TRIM(A.ICODe)||TRIM(A.COL6)=B.BRANCHCD||TRIM(B.ICODe)||TRIM(B.KCLREELNO) and b.type like '0%' where trim(a.icode)=trim(c.icodE) and A.BRANCHCD='" + frm_mbr + "' AND A.type='25' and A.enqdt " + DateRange + " group by A.enqno,A.enqdt,TRIM(A.aCODE) union all select a.enqno,a.enqdt,TRIM(a.aCODE) AS ACODE,0 as qtyin,sum(a.qty + is_number(replace(nvl(b.COL3,'0'),'-','0')) ) as qtyout,is_number(replace(nvl(a.COL3,'0'),'-','0')) as col3,sum(a.scrp1) as scrp1,sum(a.scrp2) as scrp2,sum(a.time1) as time1,sum(a.time2) as time2,0 AS QTYIN1,0 AS VAL from costestimate a left outer join (SELECT VCHNUM,VCHDATE,SUM(is_number(replace(nvl(COL3,'0'),'-','0'))) AS COL3 from inspvch WHERE BRANCHCD='" + frm_mbr + "' and type='45' group by vchnum,vchdate) b on trim(a.vchnum)||to_char(a.vchdate,'dd/mm/yyyy')=trim(b.vchnum)||to_char(b.vchdate,'dd/mm/yyyy') where a.BRANCHCD='" + frm_mbr + "' and a.type='40' and a.enqdt " + DateRange + " group by a.enqno,a.enqdt,TRIM(a.aCODE),is_number(replace(nvl(a.COL3,'0'),'-','0')) ) group by enqno,enqdt,acode) A "; //REAL
                mq1 = " ,COSTESTIMATE B left outer join SOMAS C on TRIM(SUBSTR(B.CONVDATE,1,20))||TRIM(B.ACODE)||TRIM(B.ICODE)=C.BRANCHCD||C.TYPE||TRIM(C.ORDNO)||TO_CHAR(C.ORDDT,'DD/MM/YYYY')||TRIM(C.ACODE)||TRIM(C.ICODE) WHERE TRIM(A.ENQNO)||TO_CHAR(A.ENQDT,'DD/MM/YYYY')=TRIM(B.VCHNUM)||TO_CHAR(B.VCHDATE,'DD/MM/YYYY')  and b.BRANCHCD='" + frm_mbr + "' AND B.TYPE='30' AND B.SRNO=0) A,ITEM B,inspmst c,(SELECT SUM(A.MLT_LOSS) AS MLT_LOSS,SUM(A.MLT_LOSS1) AS MLT_LOSS1,SUM(A.MLT_LOSS2) AS MLT_LOSS2,sum(a.CORR_STG_REJ) AS CORR_STG_REJ,sum(a.snp) as snp,A.job_no,to_char(to_date(A.job_Dt,'dd/mm/yyyy'),'dd/mm/yyyy') as job_dt,A.icode FROM (select sum(A.mlt_loss) as mlt_loss,0 AS mlt_loss1,0 AS mlt_loss2 ,0  AS CORR_STG_REJ,0 as snp,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A ,TYPE B where A.BRANCHCD='" + frm_mbr + "' AND TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='09' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss, sum(A.mlt_loss) as mlt_loss1,0 AS mlt_loss2,0  AS CORR_STG_REJ,0 as snp ,A.job_no,A.job_Dt,TRIM(A.icode) AS ICODE from prod_sheet A,TYPE B where A.BRANCHCD='" + frm_mbr + "' AND TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='06' group by A.job_no,A.job_Dt,TRIM(A.ICODE) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,sum(A.mlt_loss) as mlt_loss2,0 AS CORR_STG_REJ,0 as snp ,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A,TYPE B where A.BRANCHCD='" + frm_mbr + "' AND TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='11' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,0 as mlt_loss2,sum(is_number(A.A4)) AS CORR_STG_REJ,0 as snp ,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A where a.type='88' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,0 as mlt_loss2,0 AS CORR_STG_REJ ,sum(is_number(a.col5)) as snp,A.enqno,to_char(a.enqdt,'dd/mm/yyyy'),TRIM(A.icode) AS icode from costestimate A where a.type='60' group by A.enqno,to_char(a.enqdt,'dd/mm/yyyy'),TRIM(A.icode)) A GROUP BY A.job_no,to_date(A.job_Dt,'dd/mm/yyyy'),A.icode) D WHERE TRIM(A.ACODE)=TRIM(B.ICODE) and trim(A.acode)=trim(c.icode) and trim(a.enqno)||to_char(a.enqdt,'dd/mm/yyyy')||trim(a.acode)=trim(D.job_no)||to_char(to_Date(D.job_Dt,'dd/mm/yyyy'),'dd/mm/yyyy')||trim(D.icode) and c.type='70' and c.srno=10 ORDER BY TO_CHAR(A.ENQDT,'YYYYmmdd') desc,a.enqno desc)";
            }
        }

        if (indType == "FLEX")
        {
            mq0 = "SELECT fstr,JOBNO,JOBDT,ERPCODE,PRODUCT,PARTNO,ply,ups,TOT_BOX_REQ,STD_SHT_RQ_WITH_WSTG,STD_WT_PER_SHEET_per_JC,STD_WT_PERBOX_per_JC,NO_OF_SHT_RCVD,BOX_to_be_PRODUCED, round((case when nvl(WT_CONSUME,0)=0 then 1 else nvl(WT_CONSUME,0) end)/ (case when nvl(STD_WT_PERBOX_per_JC,0)=0 then 1 else nvl(STD_WT_PERBOX_per_JC,0) end),3) AS Box_to_cal_as_per_wt_consumed, LINEAR_MTR_TO_BE_PROD ,STD_WT_rQD,WT_CONSUME,gsm_var,fala,tore,core,CORR_STD_VS_ACT_wt_DIFF,CORR_STG_REJ,CORR_WT_LOSS,print_stg_rej,prt_wt_loss,gluing,glu_wt_loss,sorting_packing_rej,sorting_packing_loss ,other_S,oth_wt_loss,paper_Wstg,TOTL_REJN_NO,FINAL_BOX_PROD,FINAL_BOX_PROD_WEIGHT,WT_DIFF ,WT_WISE_REJ_PER,ROUND(((round((case when nvl(WT_CONSUME,0)=0 then 1 else nvl(WT_CONSUME,0) end)/ (case when is_number(STD_WT_PERBOX_per_JC)>0 then STD_WT_PERBOX_per_JC else 1 end ),2)-round((case when nvl(FINAL_BOX_PROD,0)=0 then 1 else nvl(FINAL_BOX_PROD,0) end),2))/round((case when nvl(WT_CONSUME,0)=0 then 1 else nvl(WT_CONSUME,0) end)/(case when is_number(STD_WT_PERBOX_per_JC)>0 then STD_WT_PERBOX_per_JC else 1 end),2))*100,3)  as BOX_WISE_REJ  ,EXCESS,SHORTAGE,matl_avg_rate,cost_of_wstg, job_vALUE, mat_cost, proft_per,profit_Value  FROM (SELECT trim(a.enqno)||to_char(a.enqdt,'dd/mm/yyyy') as fstr,A.ENQNO AS JOBNO,TO_CHAR(A.ENQDT,'DD/MM/YYYY') AS JOBDT,A.ACODE AS ERPCODE,B.INAME AS PRODUCT,B.CPARTNO AS PARTNO,c.col15 as ply,A.COL13 as ups,A.TOT_BOX_RCV as TOT_BOX_REQ,a.STD_SHT_RQ as STD_SHT_RQ_WITH_WSTG, /* (a.STD_SHT_RQ*(is_number(c.col2)/1000)) AS std_MTR_reqd,*/ round(a.enr2/a.STD_SHT_RQ,4) AS STD_WT_PER_SHEET_per_JC,round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) AS STD_WT_PERBOX_per_JC,(CASE WHEN A.COL13>0 THEN round(A.QTYOUT/A.COL13,2) ELSE A.COL3 END) AS NO_OF_SHT_RCVD,A.QTYOUT AS BOX_to_be_PRODUCED,(CASE WHEN is_number(C.BTCHDT)>0 THEN ROUND((A.QTYOUT*is_number(C.BTCHDT))/100,2) ELSE 0 END) AS LINEAR_MTR_TO_BE_PROD,round(round(a.enr2/a.STD_SHT_RQ,4) * (CASE WHEN A.COL13>0 THEN round(A.QTYOUT/A.COL13,2) ELSE A.COL3 END),3) AS STD_WT_rQD,A.QTYIN AS WT_CONSUME,a.scrp1 as gsm_var,a.scrp2 as fala,a.time1 as tore,a.time2 as core,(A.QTYIN - (round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ) /A.COL13,3)),3))) as CORR_STD_VS_ACT_wt_DIFF,d.CORR_STG_REJ,d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) as CORR_WT_LOSS,d.mlt_loss as print_stg_rej,(d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as prt_wt_loss,D.mlt_loss1 as gluing,(d.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as glu_wt_loss,d.snp as sorting_packing_rej,(d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4)) as  sorting_packing_loss , D.mlt_loss2 as other_S,(d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) as oth_wt_loss, (  (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + (D.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3))) + (d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) + (d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4)) as paper_Wstg,round(d.CORR_STG_REJ+d.mlt_loss+D.mlt_loss1+d.snp+D.mlt_loss2,2) AS TOTL_REJN_NO,A.IQTYIN AS FINAL_BOX_PROD,round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4) as FINAL_BOX_PROD_WEIGHT,A.QTYIN - round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4) as WT_DIFF,ROUND((A.QTYIN - round(A.IQTYIN * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4),4)) / (CASE WHEN A.QTYIN>0 THEN A.QTYIN ELSE 1 END)  * 100 , 3) AS WT_WISE_REJ_PER,round(((A.QTYOUT - A.IQTYIN) / (case when A.QTYOUT>0 then a.qtyout else 1 end)) * 100,3) AS BOX_WISE_REJ,(CASE WHEN (A.QTYOUT-A.IQTYIN)<0 THEN ABS(A.QTYOUT-A.IQTYIN) ELSE 0 END) AS EXCESS,(CASE WHEN (A.QTYOUT-A.IQTYIN)>0 THEN ABS(A.QTYOUT-A.IQTYIN) ELSE 0 END) AS SHORTAGE,round((case when A.QTYIN>0 and a.val>0 then round(a.val/A.QTYIN,2) else 0 end),4) as matl_avg_rate, round( (A.QTYIN - (round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ) /A.COL13,3)),3))) + (  (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + (D.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3))) + (d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/A.COL13,3)) + d.CORR_STG_REJ*round((a.enr2/a.STD_SHT_RQ)/A.COL13,4) + (d.snp * round((a.enr2/a.STD_SHT_RQ)/A.COL13,4))) * round((case when A.QTYIN>0 and a.val>0 then round(a.val/A.QTYIN,2) else 0 end),4) as cost_of_wstg,(A.IQTYIN*A.SALERATE) as job_vALUE,A.VAL AS mat_cost, (case when (A.IQTYIN*A.SALERATE)>0 then round(((A.IQTYIN*A.SALERATE)-a.val) / (A.IQTYIN*A.SALERATE) ,3)*100 else 0 end ) as proft_per,round((A.IQTYIN*A.SALERATE)-a.val ,3) as profit_Value /*,ROUND((CASE WHEN A.TOT_BOX_RCV>0 THEN ((A.TOT_BOX_RCV-A.QTYOUT)/A.TOT_BOX_RCV)*100 ELSE 0 END),2)  as variation_per*/ FROM (SELECT A.*,B.QTY AS TOT_BOX_RCV,(B.COL14+B.COL15) AS STD_SHT_RQ,b.enr1,b.enr2,B.COL13,c.IRATE AS SALERATE FROM (select enqno,enqdt,acode,sum(qtyin) as qtyin,sum(qtyout) as qtyout,sum(scrp1) as scrp1,sum(scrp2) as scrp2,sum(time1) as time1,sum(time2) as time2,sum(COL3) as col3,SUM(IQTYIN) AS IQTYIN,SUM(VAL) AS VAL from (select INVNO AS ENQNO,INVDATE AS ENQDT,TRIM(ICODE) AS ACODE,0 as qtyin,0 as qtyout,0 AS COL3,0 as scrp1,0 as scrp2,0 as time1,0 as time2,SUM(IQTYIN) AS IQTYIN,0 AS VAL from IVOUCHER where BRANCHCD='" + frm_mbr + "' AND type='16' and INVDATE " + DateRange + " group by INVNO,INVDATE,TRIM(ICODE) union all select A.enqno,A.enqdt,TRIM(A.aCODE) AS ACODE,sum(A.itate) as qtyin,0 as qtyout,0 AS COL3,sum(A.scrp1) as scrp1,sum(A.scrp2) as scrp2,sum(A.time1) as time1,sum(A.time2) as time2,0 AS QTYIN1,SUM((case when b.irate>0 then ROUND(is_number(A.col4)*B.IRATE,2) else ROUND(is_number(A.col4)*c.IRATE,2) end)) AS VAL from item c,costestimatek A left outer join (SELECT ICODE,KCLREELNO,IRATE,BRANCHCD,TYPE FROM REELVCH WHERE BRANCHCD='" + frm_mbr + "' AND TYPE IN ('02','07','08','09') /*AND VCHDATE " + xprdRange + "*/ UNION ALL SELECT ICODE,KCLREELNO,IRATE,BRANCHCD,TYPE FROM REELVCH_OP WHERE BRANCHCD='" + frm_mbr + "' AND TYPE IN ('02','07','08','09') /*AND VCHDATE " + xprdRange + "*/) B on A.BRANCHCD||TRIM(A.ICODe)||TRIM(A.COL6)=B.BRANCHCD||TRIM(B.ICODe)||TRIM(B.KCLREELNO) and b.type in ('02','07','08','09') where trim(a.icode)=trim(c.icodE) and A.BRANCHCD='" + frm_mbr + "' AND A.type='25' and A.enqdt " + DateRange + " group by A.enqno,A.enqdt,TRIM(A.aCODE) union all select a.enqno,a.enqdt,TRIM(a.aCODE) AS ACODE,0 as qtyin,sum(a.qty + is_number(replace(nvl(b.COL3,'0'),'-','0')) ) as qtyout,is_number(replace(nvl(a.COL3,'0'),'-','0')) as col3,sum(a.scrp1) as scrp1,sum(a.scrp2) as scrp2,sum(a.time1) as time1,sum(a.time2) as time2,0 AS QTYIN1,0 AS VAL from costestimatek a left outer join (SELECT VCHNUM,VCHDATE,SUM(is_number(replace(nvl(COL3,'0'),'-','0'))) AS COL3 from inspvch WHERE BRANCHCD='" + frm_mbr + "' and type='45' group by vchnum,vchdate) b on trim(a.vchnum)||to_char(a.vchdate,'dd/mm/yyyy')=trim(b.vchnum)||to_char(b.vchdate,'dd/mm/yyyy') where a.BRANCHCD='" + frm_mbr + "' and a.type='40' and a.enqdt " + DateRange + " group by a.enqno,a.enqdt,TRIM(a.aCODE),is_number(replace(nvl(a.COL3,'0'),'-','0')) ) group by enqno,enqdt,acode) A "; //REAL
            mq1 = " ,COSTESTIMATE B,SOMAS C WHERE TRIM(A.ENQNO)||TO_CHAR(A.ENQDT,'DD/MM/YYYY')=TRIM(B.VCHNUM)||TO_CHAR(B.VCHDATE,'DD/MM/YYYY') AND TRIM(SUBSTR(B.CONVDATE,1,20))||TRIM(B.ACODE)||TRIM(B.ICODE)=C.BRANCHCD||C.TYPE||TRIM(C.ORDNO)||TO_CHAR(C.ORDDT,'DD/MM/YYYY')||TRIM(C.ACODE)||TRIM(C.ICODE) and b.BRANCHCD='" + frm_mbr + "' AND B.TYPE='30' AND B.SRNO=0) A,ITEM B,inspmst c,(SELECT SUM(A.MLT_LOSS) AS MLT_LOSS,SUM(A.MLT_LOSS1) AS MLT_LOSS1,SUM(A.MLT_LOSS2) AS MLT_LOSS2,sum(a.CORR_STG_REJ) AS CORR_STG_REJ,sum(a.snp) as snp,A.job_no,to_char(to_date(A.job_Dt,'dd/mm/yyyy'),'dd/mm/yyyy') as job_dt,A.icode FROM (select sum(A.mlt_loss) as mlt_loss,0 AS mlt_loss1,0 AS mlt_loss2 ,0  AS CORR_STG_REJ,0 as snp,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A ,TYPE B where A.BRANCHCD='" + frm_mbr + "' AND TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='90' and B.RCNUM='09' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss, sum(A.mlt_loss) as mlt_loss1,0 AS mlt_loss2,0  AS CORR_STG_REJ,0 as snp ,A.job_no,A.job_Dt,TRIM(A.icode) AS ICODE from prod_sheet A,TYPE B where A.BRANCHCD='" + frm_mbr + "' AND TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='90' and B.RCNUM='06' group by A.job_no,A.job_Dt,TRIM(A.ICODE) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,sum(A.mlt_loss) as mlt_loss2,0 AS CORR_STG_REJ,0 as snp ,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A,TYPE B where A.BRANCHCD='" + frm_mbr + "' AND TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='90' and B.RCNUM='11' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,0 as mlt_loss2,sum(is_number(A.A4)) AS CORR_STG_REJ,0 as snp ,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A where a.type='88' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,0 as mlt_loss2,0 AS CORR_STG_REJ ,sum(is_number(a.col5)) as snp,A.enqno,to_char(a.enqdt,'dd/mm/yyyy'),TRIM(A.icode) AS icode from costestimate A where a.type='60' group by A.enqno,to_char(a.enqdt,'dd/mm/yyyy'),TRIM(A.icode)) A GROUP BY A.job_no,to_date(A.job_Dt,'dd/mm/yyyy'),A.icode) D WHERE TRIM(A.ACODE)=TRIM(B.ICODE) and trim(A.acode)=trim(c.icode) and trim(a.enqno)||to_char(a.enqdt,'dd/mm/yyyy')||trim(a.acode)=trim(D.job_no)||to_char(to_Date(D.job_Dt,'dd/mm/yyyy'),'dd/mm/yyyy')||trim(D.icode) and c.type='70' and c.srno=10 ORDER BY TO_CHAR(A.ENQDT,'YYYYmmdd') desc,a.enqno desc)";
        }



        if (frm_cocd == "ABOX" || frm_cocd == "MAYU")
        {
            mq0 = "SELECT trim(a.enqno)||to_char(a.enqdt,'dd/mm/yyyy') as fstr,A.ENQNO AS JOBNO,TO_CHAR(A.ENQDT,'DD/MM/YYYY') AS JOBDT,A.ACODE AS ICODE,B.INAME AS PRODUCT,c.col15 as ply,c.rejqty as ups,A.TOT_BOX_RCV as TOT_BOX_REQ,a.STD_SHT_RQ as STD_SHT_RQ_WITH_WSTG, /* (a.STD_SHT_RQ*(is_number(c.col2)/1000)) AS std_MTR_reqd,*/ round(a.enr2/a.STD_SHT_RQ,4) AS STD_WT_PER_SHEET_per_JC,round((a.enr2/a.STD_SHT_RQ)/c.rejqty,4) AS STD_WT_PERBOX_per_JC,A.COL3 AS NO_OF_SHT_RCVD,A.QTYOUT AS BOX_to_be_PRODUCED,round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)),3) AS STD_WT_rQD,A.QTYIN AS WT_CONSUME,a.scrp1 as gsm_var,a.scrp2 as fala,a.time1 as tore,a.time2 as core,(A.QTYIN - (round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ) /c.rejqty,3)),3))) as CORR_STD_VS_ACT_wt_DIFF,d.mlt_loss as print_stg_rej,(d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)) as prt_wt_loss,D.mlt_loss1 as gluing,(d.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)) as glu_wt_loss , D.mlt_loss2 as other_S,(d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)) as oth_wt_loss, (  (A.QTYIN - round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)),3)) + (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)) + (D.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3))) + (d.mlt_loss2 * round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)) as paper_Wstg ,A.IQTYIN AS FINAL_BOX_PROD,(CASE WHEN (A.TOT_BOX_RCV-A.IQTYIN)<0 THEN ABS(A.TOT_BOX_RCV-A.IQTYIN) ELSE 0 END) AS EXCESS,(CASE WHEN (A.TOT_BOX_RCV-A.IQTYIN)>0 THEN ABS(A.TOT_BOX_RCV-A.IQTYIN) ELSE 0 END) AS SHORTAGE,round((case when A.QTYIN>0 and a.val>0 then (a.val/A.QTYIN) else 0 end),4) as matl_avg_rate, round((case when A.QTYIN>0 and a.val>0 then round(a.val/A.QTYIN,3) else 0 end) * ( (A.QTYIN - round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)),3)) + (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)) + (d.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)))  ) as cost_of_wstg,(A.IQTYIN*A.SALERATE) as job_vALUE,A.VAL AS mat_cost, (case when (A.IQTYIN*A.SALERATE)>0 then round(((A.IQTYIN*A.SALERATE)-a.val) / (A.IQTYIN*A.SALERATE) ,3)*100 else 0 end ) as jOB_proft_per,round((A.IQTYIN*A.SALERATE)-a.val ,3) as JOB_profit_Value,(case when (A.QTYOUT*A.SALERATE)>0 then round(((A.QTYOUT*A.SALERATE)-a.val) / (A.QTYOUT*A.SALERATE) ,3)*100 else 0 end ) as corr_per,round((A.qtyout*A.SALERATE)-a.val ,3) as CORR_PROF_VAL, (round((A.iqtyin*A.SALERATE)-a.val ,3) - round((A.qtyout*A.SALERATE)-a.val ,3))  as diff_VALUE ,ROUND((CASE WHEN A.TOT_BOX_RCV>0 THEN ((A.TOT_BOX_RCV-A.QTYOUT)/A.TOT_BOX_RCV)*100 ELSE 0 END),2)  as variation_per FROM (SELECT A.*,B.QTY AS TOT_BOX_RCV,(B.COL14+B.COL15) AS STD_SHT_RQ,b.enr1,b.enr2,c.IRATE AS SALERATE FROM (select enqno,enqdt,acode,sum(qtyin) as qtyin,sum(qtyout) as qtyout,sum(scrp1) as scrp1,sum(scrp2) as scrp2,sum(time1) as time1,sum(time2) as time2,sum(COL3) as col3,SUM(IQTYIN) AS IQTYIN,SUM(VAL) AS VAL from (select INVNO AS ENQNO,INVDATE AS ENQDT,TRIM(ICODE) AS ACODE,0 as qtyin,0 as qtyout,0 AS COL3,0 as scrp1,0 as scrp2,0 as time1,0 as time2,SUM(IQTYIN) AS IQTYIN,0 AS VAL from IVOUCHER where BRANCHCD='" + frm_mbr + "' AND type='16' and INVDATE " + DateRange + " group by INVNO,INVDATE,TRIM(ICODE) union all select A.enqno,A.enqdt,TRIM(A.aCODE) AS ACODE,sum(A.itate) as qtyin,0 as qtyout,0 AS COL3,sum(A.scrp1) as scrp1,sum(A.scrp2) as scrp2,sum(A.time1) as time1,sum(A.time2) as time2,0 AS QTYIN1,SUM(ROUND(A.ITATE*B.IRATE,2)) AS VAL from costestimate A,REELVCH B where TRIM(A.ICODE)||TRIM(A.COL6)=TRIM(B.ICODE)||TRIM(B.KCLREELNO) AND A.BRANCHCD='" + frm_mbr + "' AND A.type='25' and b.type in ('02','07','08','09') and A.enqdt " + DateRange + " group by A.enqno,A.enqdt,TRIM(A.aCODE) union all select a.enqno,a.enqdt,TRIM(a.aCODE) AS ACODE,0 as qtyin,sum(a.qty + is_number(replace(nvl(b.COL3,'0'),'-','0')) ) as qtyout,is_number(replace(nvl(a.COL3,'0'),'-','0')) as col3,sum(a.scrp1) as scrp1,sum(a.scrp2) as scrp2,sum(a.time1) as time1,sum(a.time2) as time2,0 AS QTYIN1,0 AS VAL from costestimate a left outer join inspvch b on trim(a.vchnum)||to_char(a.vchdate,'dd/mm/yyyy')=trim(b.vchnum)||to_char(b.vchdate,'dd/mm/yyyy') and b.type='45' where a.BRANCHCD='" + frm_mbr + "' and a.type='40' and a.enqdt " + DateRange + " group by a.enqno,a.enqdt,TRIM(a.aCODE),is_number(replace(nvl(a.COL3,'0'),'-','0')) ) group by enqno,enqdt,acode) A ";
            mq1 = " ,COSTESTIMATE B,SOMAS C WHERE TRIM(A.ENQNO)||TO_CHAR(A.ENQDT,'DD/MM/YYYY')=TRIM(B.VCHNUM)||TO_CHAR(B.VCHDATE,'DD/MM/YYYY') AND TRIM(SUBSTR(B.CONVDATE,1,20))||TRIM(B.ACODE)||TRIM(B.ICODE)=C.BRANCHCD||C.TYPE||TRIM(C.ORDNO)||TO_CHAR(C.ORDDT,'DD/MM/YYYY')||TRIM(C.ACODE)||TRIM(C.ICODE) and b.BRANCHCD='" + frm_mbr + "' AND B.TYPE='30' AND B.SRNO=0) A,ITEM B,inspmst c,(SELECT SUM(A.MLT_LOSS) AS MLT_LOSS,SUM(A.MLT_LOSS1) AS MLT_LOSS1,SUM(A.MLT_LOSS2) AS MLT_LOSS2,A.job_no,A.job_Dt,A.icode FROM (select sum(A.mlt_loss) as mlt_loss,0 AS mlt_loss1,0 AS mlt_loss2 ,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A ,TYPE B where TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='09' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss, sum(A.mlt_loss) as mlt_loss1,0 AS mlt_loss2 ,A.job_no,A.job_Dt,TRIM(A.icode) AS ICODE from prod_sheet A,TYPE B where TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='06' group by A.job_no,A.job_Dt,TRIM(A.ICODE) UNION select 0 AS mlt_loss,0 AS mlt_loss1,sum(A.mlt_loss) as mlt_loss2 ,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A,TYPE B where TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='11' group by A.job_no,A.job_Dt,TRIM(A.icode)) A GROUP BY A.job_no,A.job_Dt,A.icode) D WHERE TRIM(A.ACODE)=TRIM(B.ICODE) and trim(A.acode)=trim(c.icode) and trim(a.enqno)||to_char(a.enqdt,'dd/mm/yyyy')||trim(a.acode)=trim(D.job_no)||to_char(to_Date(D.job_Dt,'dd/mm/yyyy'),'dd/mm/yyyy')||trim(D.icode) and c.type='70' and c.srno=10 ORDER BY TO_CHAR(A.ENQDT,'YYYYmmdd') desc,a.enqno desc";
        }
        if (frm_cocd == "SYDB" || frm_cocd == "ALIN*")
        {
            mq0 = "SELECT trim(a.enqno)||to_char(a.enqdt,'dd/mm/yyyy') as fstr,A.ENQNO AS JOBNO,TO_CHAR(A.ENQDT,'DD/MM/YYYY') AS JOBDT,A.ACODE AS ICODE,B.INAME AS PRODUCT,c.col15 as ply,c.rejqty as ups,A.TOT_BOX_RCV as TOT_BOX_REQ,a.STD_SHT_RQ as STD_SHT_RQ_WITH_WSTG, /* (a.STD_SHT_RQ*(is_number(c.col2)/1000)) AS std_MTR_reqd,*/ round(a.enr2/a.STD_SHT_RQ,4) AS STD_WT_PER_SHEET_per_JC,round((a.enr2/a.STD_SHT_RQ)/c.rejqty,4) AS STD_WT_PERBOX_per_JC,A.COL3 AS NO_OF_SHT_RCVD,A.QTYOUT AS BOX_to_be_PRODUCED,round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)),3) AS STD_WT_rQD,A.QTYIN AS WT_CONSUME,a.scrp1 as gsm_var,a.scrp2 as fala,a.time1 as tore,a.time2 as core,(A.QTYIN - (round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ) /c.rejqty,3)),3))) as CORR_STD_VS_ACT_wt_DIFF,A.SHT_QT AS BOX_WT_WTH_DUPLEX,A.SHT_QT*2 AS SHEET_WT_WTH_DUPLEX,d.mlt_loss as print_stg_rej,(d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)) as prt_wt_loss,D.mlt_loss1 as gluing,(d.mlt_loss1)*A.SHT_QT as glu_wt_loss , D.mlt_loss2 as other_S,D.mlt_loss2*A.SHT_QT as oth_wt_loss, (  (A.QTYIN - round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)),3)) + (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)) + ((d.mlt_loss1)*A.SHT_QT)) + (D.mlt_loss2*A.SHT_QT)  as paper_Wstg ,A.IQTYIN AS FINAL_BOX_PROD,(CASE WHEN (A.TOT_BOX_RCV-A.IQTYIN)<0 THEN ABS(A.TOT_BOX_RCV-A.IQTYIN) ELSE 0 END) AS EXCESS,(CASE WHEN (A.TOT_BOX_RCV-A.IQTYIN)>0 THEN ABS(A.TOT_BOX_RCV-A.IQTYIN) ELSE 0 END) AS SHORTAGE,round((case when A.QTYIN>0 and a.val>0 then (a.val/A.QTYIN) else 0 end),4) as matl_avg_rate, round((case when A.QTYIN>0 and a.val>0 then round(a.val/A.QTYIN,3) else 0 end) * ( (A.QTYIN - round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)),3)) + (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)) + (d.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)))  ) as cost_of_wstg,(A.IQTYIN*A.SALERATE) as job_vALUE,A.VAL AS mat_cost, (case when (A.IQTYIN*A.SALERATE)>0 then round(((A.IQTYIN*A.SALERATE)-a.val) / (A.IQTYIN*A.SALERATE) ,3)*100 else 0 end ) as proft_per,round((A.IQTYIN*A.SALERATE)-a.val ,3) as profit_Value,ROUND((CASE WHEN A.TOT_BOX_RCV>0 THEN ((A.TOT_BOX_RCV-A.QTYOUT)/A.TOT_BOX_RCV)*100 ELSE 0 END),2)  as variation_per FROM (SELECT A.*,B.QTY AS TOT_BOX_RCV,(B.COL14+B.COL15) AS STD_SHT_RQ,B.ITATE AS enr1,B.ITATE AS enr2,c.IRATE AS SALERATE,ROUND(sum((B.col7*D.IWEIGHT)+B.iTate)/60000,3) AS sht_qt FROM (select enqno,enqdt,acode,sum(qtyin) as qtyin,sum(qtyout) as qtyout,sum(scrp1) as scrp1,sum(scrp2) as scrp2,sum(time1) as time1,sum(time2) as time2,sum(COL3) as col3,SUM(IQTYIN) AS IQTYIN,SUM(VAL) AS VAL from (select INVNO AS ENQNO,INVDATE AS ENQDT,TRIM(ICODE) AS ACODE,0 as qtyin,0 as qtyout,0 AS COL3,0 as scrp1,0 as scrp2,0 as time1,0 as time2,SUM(IQTYIN) AS IQTYIN,0 AS VAL from IVOUCHER where BRANCHCD='" + frm_mbr + "' AND type='16' and INVDATE " + DateRange + " group by INVNO,INVDATE,TRIM(ICODE) union all select A.enqno,A.enqdt,TRIM(A.aCODE) AS ACODE,sum(A.itate) as qtyin,0 as qtyout,0 AS COL3,sum(A.scrp1) as scrp1,sum(A.scrp2) as scrp2,sum(A.time1) as time1,sum(A.time2) as time2,0 AS QTYIN1,SUM(ROUND(A.ITATE*B.IRATE,2)) AS VAL from costestimate A,REELVCH B where TRIM(A.ICODE)||TRIM(A.COL6)=TRIM(B.ICODE)||TRIM(B.KCLREELNO) AND A.BRANCHCD='" + frm_mbr + "' AND A.type='25' and b.type in ('02','07','08','09') and A.enqdt " + DateRange + " group by A.enqno,A.enqdt,TRIM(A.aCODE) union all select a.enqno,a.enqdt,TRIM(a.aCODE) AS ACODE,0 as qtyin,sum(a.qty + is_number(replace(nvl(b.COL3,'0'),'-','0')) ) as qtyout,is_number(replace(nvl(a.COL3,'0'),'-','0')) as col3,sum(a.scrp1) as scrp1,sum(a.scrp2) as scrp2,sum(a.time1) as time1,sum(a.time2) as time2,0 AS QTYIN1,0 AS VAL from costestimate a left outer join inspvch b on trim(a.vchnum)||to_char(a.vchdate,'dd/mm/yyyy')=trim(b.vchnum)||to_char(b.vchdate,'dd/mm/yyyy') and b.type='45' where a.BRANCHCD='" + frm_mbr + "' and a.type='40' and a.enqdt " + DateRange + " group by a.enqno,a.enqdt,TRIM(a.aCODE),is_number(replace(nvl(a.COL3,'0'),'-','0')) ) group by enqno,enqdt,acode) A ";
            mq1 = " ,COSTESTIMATE B,SOMAS C,ITEM D WHERE TRIM(A.ENQNO)||TO_CHAR(A.ENQDT,'DD/MM/YYYY')=TRIM(B.VCHNUM)||TO_CHAR(B.VCHDATE,'DD/MM/YYYY') AND TRIM(SUBSTR(B.CONVDATE,1,20))||TRIM(B.ACODE)||TRIM(B.ICODE)=C.BRANCHCD||C.TYPE||TRIM(C.ORDNO)||TO_CHAR(C.ORDDT,'DD/MM/YYYY')||TRIM(C.ACODE)||TRIM(C.ICODE) AND TRIM(B.COL9)=TRIM(d.ICODE) and b.BRANCHCD='" + frm_mbr + "' AND B.TYPE='30' and b.COL9 not like '07%' group by B.ITATE,c.IRATE,a.enqno,a.enqdt,a.acode,a.qtyin,a.qtyout,a.scrp1,a.scrp2,a.time1,a.time2,a.col3,a.IQTYIN,a.VAL,B.QTY ,(B.COL14+B.COL15)) A,ITEM B,inspmst c,(SELECT SUM(A.MLT_LOSS) AS MLT_LOSS,SUM(A.MLT_LOSS1) AS MLT_LOSS1,SUM(A.MLT_LOSS2) AS MLT_LOSS2,A.job_no,A.job_Dt,A.icode FROM (select sum(A.mlt_loss) as mlt_loss,0 AS mlt_loss1,0 AS mlt_loss2 ,A.job_no,TRIM(A.job_Dt) AS job_Dt,TRIM(A.icode) AS icode from prod_sheet A ,TYPE B where TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='09' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss, sum(A.mlt_loss) as mlt_loss1,0 AS mlt_loss2 ,A.job_no,TRIM(A.job_Dt),TRIM(A.icode) AS ICODE from prod_sheet A,TYPE B where TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='06' group by A.job_no,A.job_Dt,TRIM(A.ICODE) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,sum(A.mlt_loss) as mlt_loss2 ,A.job_no,TRIM(A.job_Dt),TRIM(A.icode) AS icode from prod_sheet A,TYPE B where TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='11' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,sum(A.REJ_RW) as mlt_loss2 ,A.INVNO,TO_CHAR(A.INVDATE,'DD/MM/YYYY') AS INVDATE,TRIM(A.icode) AS icode from IVOUCHER A where A.BRANCHCD='" + frm_mbr + "' AND A.type='16' AND A.INVDATE " + DateRange + " group by A.INVNO,TO_CHAR(A.INVDATE,'DD/MM/YYYY'),TRIM(A.icode)) a group by (a.icode),a.job_no,a.job_Dt ) D WHERE TRIM(A.ACODE)=TRIM(B.ICODE) and trim(A.acode)=trim(c.icode) and trim(a.enqno)||to_char(a.enqdt,'dd/mm/yyyy')||trim(a.acode)=trim(D.job_no)||to_char(to_Date(D.job_Dt,'dd/mm/yyyy'),'dd/mm/yyyy')||trim(D.icode) and c.type='70' and c.srno=10 ORDER BY TO_CHAR(A.ENQDT,'YYYYmmdd') desc,a.enqno desc";

            if (frm_mbr == "01")
            {
                mq0 = "SELECT trim(a.enqno)||to_char(a.enqdt,'dd/mm/yyyy') as fstr,A.ENQNO AS JOBNO,TO_CHAR(A.ENQDT,'DD/MM/YYYY') AS JOBDT,A.ACODE AS ICODE,B.INAME AS PRODUCT,c.col15 as ply,c.rejqty as ups,A.TOT_BOX_RCV as TOT_BOX_REQ,a.STD_SHT_RQ as STD_SHT_RQ_WITH_WSTG, /* (a.STD_SHT_RQ*(is_number(c.col2)/1000)) AS std_MTR_reqd,*/ round(a.enr2/a.STD_SHT_RQ,4) AS STD_WT_PER_SHEET_per_JC,round((a.enr2/a.STD_SHT_RQ)/c.rejqty,4) AS STD_WT_PERBOX_per_JC,A.COL3 AS NO_OF_SHT_RCVD,A.QTYOUT AS BOX_to_be_PRODUCED,round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)),3) AS STD_WT_rQD,A.QTYIN AS WT_CONSUME,a.scrp1 as gsm_var,a.scrp2 as fala,a.time1 as tore,a.time2 as core,(A.QTYIN - (round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ) /c.rejqty,3)),3))) as CORR_STD_VS_ACT_wt_DIFF,A.SHT_QT AS BOX_WT_WTH_DUPLEX,A.SHT_QT*2 AS SHEET_WT_WTH_DUPLEX,d.mlt_loss as print_stg_rej,(d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)) as prt_wt_loss,D.mlt_loss1 as gluing,(d.mlt_loss1)*A.SHT_QT as glu_wt_loss , D.mlt_loss2 as other_S,D.mlt_loss2*A.SHT_QT as oth_wt_loss, (  (A.QTYIN - round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)),3)) + (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)) + ((d.mlt_loss1)*A.SHT_QT)) + (D.mlt_loss2*A.SHT_QT)  as paper_Wstg ,A.IQTYIN AS FINAL_BOX_PROD,(CASE WHEN (A.TOT_BOX_RCV-A.IQTYIN)<0 THEN ABS(A.TOT_BOX_RCV-A.IQTYIN) ELSE 0 END) AS EXCESS,(CASE WHEN (A.TOT_BOX_RCV-A.IQTYIN)>0 THEN ABS(A.TOT_BOX_RCV-A.IQTYIN) ELSE 0 END) AS SHORTAGE,round((case when A.QTYIN>0 and a.val>0 then (a.val/A.QTYIN) else 0 end),4) as matl_avg_rate, round((case when A.QTYIN>0 and a.val>0 then round(a.val/A.QTYIN,3) else 0 end) * ( (A.QTYIN - round(A.QTYOUT * (round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)),3)) + (d.mlt_loss * round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)) + (d.mlt_loss1 * round((a.enr2/a.STD_SHT_RQ)/c.rejqty,3)))  ) as cost_of_wstg,(A.IQTYIN*A.SALERATE) as job_vALUE,A.VAL AS mat_cost, (case when (A.IQTYIN*A.SALERATE)>0 then round(((A.IQTYIN*A.SALERATE)-a.val) / (A.IQTYIN*A.SALERATE) ,3)*100 else 0 end ) as proft_per,round((A.IQTYIN*A.SALERATE)-a.val ,3) as profit_Value,ROUND((CASE WHEN A.TOT_BOX_RCV>0 THEN ((A.TOT_BOX_RCV-A.QTYOUT)/A.TOT_BOX_RCV)*100 ELSE 0 END),2)  as variation_per FROM (SELECT A.*,B.QTY AS TOT_BOX_RCV,(B.COL14+B.COL15) AS STD_SHT_RQ,B.ITATE AS enr1,B.ITATE AS enr2,c.IRATE AS SALERATE,ROUND(sum((B.col7*D.IWEIGHT)+B.iTate)/60000,3) AS sht_qt FROM (select enqno,enqdt,acode,sum(qtyin) as qtyin,sum(qtyout) as qtyout,sum(scrp1) as scrp1,sum(scrp2) as scrp2,sum(time1) as time1,sum(time2) as time2,sum(COL3) as col3,SUM(IQTYIN) AS IQTYIN,SUM(VAL) AS VAL from (select INVNO AS ENQNO,INVDATE AS ENQDT,TRIM(ICODE) AS ACODE,0 as qtyin,0 as qtyout,0 AS COL3,0 as scrp1,0 as scrp2,0 as time1,0 as time2,SUM(IQTYIN) AS IQTYIN,0 AS VAL from IVOUCHER where BRANCHCD='" + frm_mbr + "' AND type='16' and INVDATE " + DateRange + " group by INVNO,INVDATE,TRIM(ICODE) union all select A.enqno,A.enqdt,TRIM(A.aCODE) AS ACODE,sum(A.itate) as qtyin,0 as qtyout,0 AS COL3,sum(A.scrp1) as scrp1,sum(A.scrp2) as scrp2,sum(A.time1) as time1,sum(A.time2) as time2,0 AS QTYIN1,SUM(ROUND(A.ITATE*B.IRATE,2)) AS VAL from costestimate A,REELVCH B where TRIM(A.ICODE)||TRIM(A.COL6)=TRIM(B.ICODE)||TRIM(B.KCLREELNO) AND A.BRANCHCD='" + frm_mbr + "' AND A.type='25' and b.type in ('02','07','08','09') and A.enqdt " + DateRange + " group by A.enqno,A.enqdt,TRIM(A.aCODE) union all select A.enqno,A.enqdt,TRIM(A.aCODE) AS ACODE,0 as qtyin,0 as qtyout,0 AS COL3,0 as scrp1,0 as scrp2,0 as time1,0 as time2,0 AS QTYIN1,SUM(ROUND(A.ITATE*B.IRATE,2)) AS VAL from costestimate A,ivoucher B where TRIM(A.ICODE)||trim(a.enqno)||to_Char(a.enqdt,'dd/mm/yyyy')=TRIM(B.ICODE)||TRIM(B.invno)||to_Char(B.invdate,'dd/mm/yyyy') AND A.BRANCHCD='" + frm_mbr + "' AND A.type='25' AND B.TYPE like '30%' and A.enqdt " + DateRange + " group by A.enqno,A.enqdt,TRIM(A.aCODE) union all select a.enqno,a.enqdt,TRIM(a.aCODE) AS ACODE,0 as qtyin,sum(a.qty + is_number(replace(nvl(b.COL3,'0'),'-','0')) ) as qtyout,is_number(replace(nvl(a.COL3,'0'),'-','0')) as col3,sum(a.scrp1) as scrp1,sum(a.scrp2) as scrp2,sum(a.time1) as time1,sum(a.time2) as time2,0 AS QTYIN1,0 AS VAL from costestimate a left outer join inspvch b on trim(a.vchnum)||to_char(a.vchdate,'dd/mm/yyyy')=trim(b.vchnum)||to_char(b.vchdate,'dd/mm/yyyy') and b.type='45' where a.BRANCHCD='" + frm_mbr + "' and a.type='40' and a.enqdt " + DateRange + " group by a.enqno,a.enqdt,TRIM(a.aCODE),is_number(replace(nvl(a.COL3,'0'),'-','0')) ) group by enqno,enqdt,acode) A ";
                mq1 = " ,COSTESTIMATE B,SOMAS C,ITEM D WHERE TRIM(A.ENQNO)||TO_CHAR(A.ENQDT,'DD/MM/YYYY')=TRIM(B.VCHNUM)||TO_CHAR(B.VCHDATE,'DD/MM/YYYY') AND TRIM(SUBSTR(B.CONVDATE,1,20))||TRIM(B.ACODE)||TRIM(B.ICODE)=C.BRANCHCD||C.TYPE||TRIM(C.ORDNO)||TO_CHAR(C.ORDDT,'DD/MM/YYYY')||TRIM(C.ACODE)||TRIM(C.ICODE) AND TRIM(B.COL9)=TRIM(d.ICODE) and b.BRANCHCD='" + frm_mbr + "' AND B.TYPE='30' and b.COL9 not like '07%' group by B.ITATE,c.IRATE,a.enqno,a.enqdt,a.acode,a.qtyin,a.qtyout,a.scrp1,a.scrp2,a.time1,a.time2,a.col3,a.IQTYIN,a.VAL,B.QTY ,(B.COL14+B.COL15)) A,ITEM B,inspmst c,(SELECT SUM(A.MLT_LOSS) AS MLT_LOSS,SUM(A.MLT_LOSS1) AS MLT_LOSS1,SUM(A.MLT_LOSS2) AS MLT_LOSS2,A.job_no,A.job_Dt,A.icode FROM (select sum(A.mlt_loss) as mlt_loss,0 AS mlt_loss1,0 AS mlt_loss2 ,A.job_no,TRIM(A.job_Dt) AS job_Dt,TRIM(A.icode) AS icode from prod_sheet A ,TYPE B where TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='09' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss, sum(A.mlt_loss) as mlt_loss1,0 AS mlt_loss2 ,A.job_no,TRIM(A.job_Dt),TRIM(A.icode) AS ICODE from prod_sheet A,TYPE B where TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='06' group by A.job_no,A.job_Dt,TRIM(A.ICODE) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,sum(A.mlt_loss) as mlt_loss2 ,A.job_no,TRIM(A.job_Dt),TRIM(A.icode) AS icode from prod_sheet A,TYPE B where TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='11' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss,0 AS mlt_loss1,sum(A.REJ_RW) as mlt_loss2 ,A.INVNO,TO_CHAR(A.INVDATE,'DD/MM/YYYY') AS INVDATE,TRIM(A.icode) AS icode from IVOUCHER A where A.BRANCHCD='" + frm_mbr + "' AND A.type='16' AND A.INVDATE " + DateRange + " group by A.INVNO,TO_CHAR(A.INVDATE,'DD/MM/YYYY'),TRIM(A.icode)) a group by (a.icode),a.job_no,a.job_Dt ) D WHERE TRIM(A.ACODE)=TRIM(B.ICODE) and trim(A.acode)=trim(c.icode) and trim(a.enqno)||to_char(a.enqdt,'dd/mm/yyyy')||trim(a.acode)=trim(D.job_no)||to_char(to_Date(D.job_Dt,'dd/mm/yyyy'),'dd/mm/yyyy')||trim(D.icode) and c.type='70' and c.srno=10 ORDER BY TO_CHAR(A.ENQDT,'YYYYmmdd') desc,a.enqno desc";
            }
        }

        SQuery = mq0 + mq1;

        ViewState["SQUERY"] = SQuery;

        dt = new DataTable();
        dt = fgen.getdata(frm_qstr, frm_cocd, SQuery);
        DataTable neWDt = dt.Copy();
        ViewState["sg1"] = neWDt;
        if (neWDt.Rows.Count > 0)
            fillgrid();
        else fgen.msg("-", "AMSG", "No Data Found!!");
        fgen.EnableForm(this.Controls);
    }
    void fillgrid()
    {
        makeColNameAsMine(dt);

        GridView1.DataSource = dt;
        GridView1.DataBind();

        hideAndRenameCol();

    }
    void makeColNameAsMine(DataTable dtColNameTable)
    {
        int colFound = dtColNameTable.Columns.Count;
        int colSrno = 0;
        for (int i = 0; i <= totCol; i++)
        {
            if (i == 0) dtColNameTable.Columns[i].ColumnName = "fstr";
            else
            {
                if (colFound > i) dtColNameTable.Columns[i].ColumnName = "sg1_f" + colSrno;
                else dtColNameTable.Columns.Add("sg1_f" + colSrno, typeof(string));
            }
            colSrno++;
        }
    }
    void hideAndRenameCol()
    {
        DataTable dtColNameTab = (DataTable)ViewState["sg1"];
        int colFound = dtColNameTab.Columns.Count;
        int totResrvCol = 1;
        double totWidth = 0;
        int widthMake = 0;
        for (int i = totResrvCol; i <= totCol; i++)
        {
            if (colFound + totResrvCol > i)
            {
                GridView1.HeaderRow.Cells[i].Text = dtColNameTab.Columns[i - totResrvCol].ColumnName;
                if (GridView1.Rows.Count > 0)
                {
                    widthMake = (GridView1.Rows[0].Cells[i].Text.Trim().Length) * 10;
                    if (widthMake < 50) widthMake = 50;
                    if (widthMake > 200) widthMake = 200;
                    totWidth += Convert.ToDouble(widthMake);
                    GridView1.Columns[i].HeaderStyle.Width = widthMake;
                    if (GridView1.Columns[i].HeaderStyle.CssClass == "hidden")
                    {
                        if (i > 1)
                        {
                            GridView1.Columns[i].HeaderStyle.CssClass = "";
                            GridView1.Rows[0].Cells[i].CssClass = "";
                        }
                    }
                }
            }
            else
            {
                GridView1.Columns[i].HeaderStyle.CssClass = "hidden";
                GridView1.Rows[0].Cells[i].CssClass = "hidden";
            }
        }
    }
    //------------------------------------------------------------------------------------
    void save_fun()
    {
        oporow = oDS.Tables[0].NewRow();
        oporow["BRANCHCD"] = frm_mbr;
        oporow["TYPE"] = vty;
        oporow["vchnum"] = vchnum;
        oporow["vchdate"] = txtvchdate.Text.Trim();
        oDS.Tables[0].Rows.Add(oporow);
    }
    //------------------------------------------------------------------------------------

    protected void GridView1_RowCreated(object sender, GridViewRowEventArgs e)
    {
        if (e.Row.RowType == DataControlRowType.DataRow)
        {
            e.Row.TabIndex = 1;
            if (Convert.ToDouble(e.Row.RowIndex.ToString()) == 0) e.Row.Attributes["onfocus"] = string.Format("javascript:SelectRow(this, {0});", e.Row.RowIndex);
            e.Row.Attributes["onclick"] = string.Format("javascript:SelectRow(this, {0});", e.Row.RowIndex);
            e.Row.Attributes["onkeydown"] = "if (event.keyCode != 13) { javascript:return SelectSibling(event); }";
            e.Row.Attributes["onselectstart"] = "javascript:return false;";
        }
    }
    //------------------------------------------------------------------------------------
    protected void GridView1_RowDataBound(object sender, GridViewRowEventArgs e)
    {
        if (e.Row.RowType == DataControlRowType.DataRow)
        {
            e.Row.Attributes["ondblclick"] = ClientScript.GetPostBackClientHyperlink(GridView1, "Select$" + e.Row.RowIndex);
            //if (co_cd == "MANU") e.Row.Attributes["onclick"] = ClientScript.GetPostBackClientHyperlink(GridView1, "Select$" + e.Row.RowIndex);
            //else e.Row.Attributes["ondblclick"] = ClientScript.GetPostBackClientHyperlink(GridView1, "Select$" + e.Row.RowIndex);
            e.Row.Attributes["onkeypress"] = "if (event.keyCode == 13) {" + ClientScript.GetPostBackClientHyperlink(GridView1, "Select$" + e.Row.RowIndex) + ";}";
            e.Row.ToolTip = "Click to select this row.";

            GridView1.Columns[0].HeaderStyle.CssClass = "hidden";
            e.Row.Cells[0].CssClass = "hidden";
            GridView1.Columns[1].HeaderStyle.CssClass = "hidden";
            e.Row.Cells[1].CssClass = "hidden";
        }
    }
    //------------------------------------------------------------------------------------
    protected void GridView1_SelectedIndexChanged(object sender, EventArgs e)
    {
        fromdt = fgenMV.Fn_Get_Mvar(frm_qstr, "U_MDT1").ToString().Trim().Replace("&amp", "");
        todt = fgenMV.Fn_Get_Mvar(frm_qstr, "U_MDT2").ToString().Trim().Replace("&amp", "");

        DateRange = "between to_Date('" + fromdt + "','dd/mm/yyyy') and to_date('" + todt + "','dd/mm/yyyy')";
        xprdRange = DateRange;
        GridViewRow row = GridView1.SelectedRow;
        col1 = row.Cells[1].Text.Trim();
        col3 = "";

        for (int j = 1; j < row.Cells.Count; j++)
        {
            if (col3.Length > 0) col3 = col3 + ",'" + row.Cells[j].Text.Trim() + "' as " + GridView1.HeaderRow.Cells[j].Text.Trim().ToUpper().Replace("<BR/>", "").Replace(" ", "_");
            else col3 = "'" + row.Cells[j].Text.Trim() + "' as " + GridView1.HeaderRow.Cells[j].Text.Trim().Replace("<BR/>", "").Replace(" ", "_");
        }

        SQuery = "select a.*,B.INAME,B.CPARTNO,B.UNIT,C.ANAME ," + col3 + " from (SELECT TRIM(A.ICODE) AS ICODE,A.COL6,is_number(A.COL4) as COL4,A.ENQNO,A.ENQDT,B.IRATE,C.IRATE AS SORATE,C.ORDNO,C.ORDDT,C.ACODE,C.PORDNO,C.PORDDT,c.qtyord FROM COSTESTIMATE A left outer join (SELECT ICODE,KCLREELNO,IRATE,BRANCHCD,TYPE FROM REELVCH WHERE BRANCHCD='" + frm_mbr + "' AND TYPE IN ('02','07','08','09') AND VCHDATE " + xprdRange + " UNION ALL SELECT ICODE,KCLREELNO,IRATE,BRANCHCD,TYPE FROM REELVCH_OP WHERE BRANCHCD='" + frm_mbr + "' AND TYPE IN ('02','07','08','09') AND VCHDATE " + xprdRange + ") B on A.BRANCHCD||TRIM(A.ICODe)||TRIM(A.COL6)=B.BRANCHCD||TRIM(B.ICODe)||TRIM(B.KCLREELNO) and b.type in ('02','07','08','09') ,SOMAS C,costestimate d WHERE TRIM(SUBSTR(d.CONVDATE,0,20))||TRIM(A.ACODe)=C.BRANCHCD||C.TYPE||TRIM(C.ORDNO)||TO_CHAR(C.ORDDT,'DD/MM/YYYY')||TRIM(C.ICODE) and a.branchcd||TRIM(A.ENQNO)||TO_CHAR(a.ENQDT,'DD/MM/YYYY')=d.branchcd||trim(d.vchnum)||to_char(d.vchdate,'dd/mm/yyyy') AND A.BRANCHCD='" + frm_mbr + "' AND A.TYPE='25' AND d.type='30' and d.srno=1 AND TRIM(A.ENQNO)||TO_CHAR(A.ENQDT,'DD/MM/YYYY')='" + col1 + "') A,ITEM B,FAMST C WHERE TRIM(a.ICODE)=TRIM(b.ICODE) AND TRIM(a.ACODe)=TRIM(C.ACODe) ORDER BY A.COL6 ";

        if ((frm_cocd == "SYDB" && frm_mbr == "01") || (frm_cocd == "PRIN" && frm_mbr == "01") || frm_cocd == "RUCH" || frm_cocd == "HIBB" || frm_cocd == "SURY")
        {
            dt = new DataTable();
            // dt = fgen.getdata(co_cd, SQuery);
            dt = fgen.getdata(frm_qstr, frm_cocd, SQuery);

            dt1 = new DataTable();
            SQuery = "select a.icode,(is_number(a.col4)*b.iweight) as col4,a.col6,a.ENQNO,a.ENQDT,a.IRATE,a.SORATE,a.ORDNO,a.ORDDT,a.ACODE,a.PORDNO,a.PORDDT,a.qtyord,B.INAME||' : (Wt. Per Sheet-'||b.iweight||'), Issued Sheet : '||a.col4 as iname ,B.CPARTNO,B.UNIT,C.ANAME ," + col3 + " from (SELECT TRIM(A.ICODE) AS ICODE,A.vchnum||'-'||to_char(a.vchdate,'dd/mm/yyyy') as col6,A.iqtyout as col4,A.invno as ENQNO,to_char(A.invdate,'dd/mm/yyyy') ENQDT,a.IRATE,C.IRATE AS SORATE,C.ORDNO,C.ORDDT,C.ACODE,C.PORDNO,C.PORDDT,c.qtyord FROM ivoucher A,SOMAS C,costestimate d WHERE TRIM(SUBSTR(d.CONVDATE,0,20))||TRIM(D.ICODE)=C.BRANCHCD||C.TYPE||TRIM(C.ORDNO)||TO_CHAR(C.ORDDT,'DD/MM/YYYY')||TRIM(C.ICODE) and a.branchcd||TRIM(A.invno)||TO_CHAR(a.invdate,'DD/MM/YYYY')=d.branchcd||trim(d.vchnum)||to_char(d.vchdate,'dd/mm/yyyy') AND A.BRANCHCD='" + frm_mbr + "' AND A.TYPE='30' and d.type='30' and d.srno=1 AND TRIM(A.invno)||TO_CHAR(A.invdate,'DD/MM/YYYY')='" + col1 + "' ) A,ITEM B,FAMST C WHERE TRIM(a.ICODE)=TRIM(b.ICODE) AND TRIM(a.ACODe)=TRIM(C.ACODe) ORDER BY A.COL6 ";
            // dt1 = fgen.getdata(co_cd, SQuery);
            dt1 = fgen.getdata(frm_qstr, frm_cocd, SQuery);
            oporow = null;

            if (dt.Rows.Count <= 0)
            {
                dt = new DataTable();
                dt = dt1.Clone();
            }

            foreach (DataRow dr1 in dt1.Rows)
            {
                dt.ImportRow(dr1);
                //oporow = dt.NewRow();
                //oporow["icode"] = dr1["icode"].ToString().Trim();
                //oporow["col6"] = dr1["vchnum"].ToString().Trim() + "-" + dr1["vchdate"].ToString().Trim();
                //oporow["col4"] = dr1["iqtyout"].ToString().Trim();
                //oporow["enqno"] = dr1["invno"].ToString().Trim();
                //oporow["enqdt"] = dr1["invdate"].ToString().Trim();
                //oporow["irate"] = dr1["irate"].ToString().Trim();
                //oporow["sorate"] = dr1["irate"].ToString().Trim();
                //oporow["ordno"] = dr1["vchnum"].ToString().Trim();
                //oporow["orddt"] = dr1["vchdate"].ToString().Trim();
                //oporow["acode"] = dr1["icode"].ToString().Trim();
                //oporow["pordno"] = dr1["vchnum"].ToString().Trim();
                //oporow["porddt"] = dr1["vchdate"].ToString().Trim();
                //oporow["qtyord"] = dr1["iqtyout"].ToString().Trim();
                //dt.Rows.Add(oporow);
            }
            ds = new DataSet();
            dt.TableName = "Prepcur";
            ds.Tables.Add(dt);

            // fgen.Print_Report_BYDT(frm_cocd,frm_mbr, "parta_detl", "parta_detl", dt);
            fgen.Print_Report_BYDS(frm_cocd, frm_qstr, frm_mbr, "parta_detl", "parta_detl", ds, "-");
        }
        if (frm_cocd == "ALIN")
        {
            dt = new DataTable();
            //   dt = fgen.getdata(co_cd, SQuery);
            dt = fgen.getdata(frm_qstr, frm_cocd, SQuery);
            foreach (DataRow dru in dt.Rows)
            {
                if (fgen.make_double(dru["irate"].ToString().Trim()) <= 0)
                {
                    col1 = fgen.seek_iname(frm_qstr, frm_cocd, "SELECT * FROM (SELECT (CASE WHEN A.ICHGS>0 THEN A.ICHGS ELSE B.IRATE END) AS IRATE,TO_cHAR(A.VCHDATE,'YYYYMMDD') AS VDD FROM IVOUCHER A,ITEM B WHERE TRIM(A.ICODE)=TRIM(b.ICODE) AND A.BRANCHCD='" + frm_mbr + "' AND A.TYPE LIKE '0%' AND A.VCHDATE BETWEEN SYSDATE AND (SYSDATE-500) AND TRIM(A.ICODE)='" + dru["ICODE"].ToString().Trim() + "' ORDER BY VDD) WHERE ROWNUM<3", "IRATE");
                    if (fgen.make_double(col1) <= 0) col1 = fgen.seek_iname(frm_qstr, frm_cocd, "SELECT IRATE FROM ITEM WHERE ICODE='" + dru["ICODE"].ToString().Trim() + "'", "IRATE");
                    dru["irate"] = col1;
                }
            }
            if (dt.Rows.Count > 0)
            {
                col3 = dt.Rows[0]["ups"].ToString().Trim();
                dt1 = new DataTable();
                SQuery = "SELECT SUM(A.MLT_LOSS) AS MLT_LOSS,SUM(A.MLT_LOSS1) AS MLT_LOSS1,SUM(A.MLT_LOSS2) AS MLT_LOSS2,A.job_no,A.job_Dt,A.icode FROM (select (CASE WHEN B.BALOP='0' THEN round(A.MLT_LOSS,2)*" + col3 + " ELSE round(A.MLT_LOSS,2) END ) as mlt_loss,0 AS mlt_loss1,0 AS mlt_loss2 ,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A ,TYPE B where TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='09' group by A.job_no,A.job_Dt,TRIM(A.icode) UNION ALL select 0 AS mlt_loss, (CASE WHEN B.BALOP='0' THEN round(A.MLT_LOSS,2)*" + col3 + " ELSE round(A.MLT_LOSS,2) END ) as mlt_loss1,0 AS mlt_loss2 ,A.job_no,A.job_Dt,TRIM(A.icode) AS ICODE from prod_sheet A,TYPE B where TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='06' group by A.job_no,A.job_Dt,TRIM(A.ICODE) UNION select 0 AS mlt_loss,0 AS mlt_loss1,(CASE WHEN B.BALOP='0' THEN round(A.MLT_LOSS,2)*" + col3 + " ELSE round(A.MLT_LOSS,2) END ) as mlt_loss2 ,A.job_no,A.job_Dt,TRIM(A.icode) AS icode from prod_sheet A,TYPE B where TRIM(A.STAGE)=TRIM(B.TYPE1) AND B.ID='K' AND A.type='86' and B.RCNUM='11' group by A.job_no,A.job_Dt,TRIM(A.icode)) A where A.JOB_NO='" + dt.Rows[0]["ENQNO"].ToString().Trim() + "' AND A.JOB_DT='" + dt.Rows[0]["ENQDT"].ToString().Trim() + "' AND A.ICODE='" + dt.Rows[0]["ICODE1"].ToString().Trim() + "' GROUP BY A.job_no,A.job_Dt,A.icode";
                dt.Columns.Add(new DataColumn("PapWstg", typeof(double)));
            }
            ds = new DataSet();
            dt.TableName = "Prepcur";
            ds.Tables.Add(dt);
            //fgen.Print_Report_BYDT(co_cd, mbr, "parta_detl", "parta_detl", dt);       
            fgen.Print_Report_BYDS(frm_cocd, frm_qstr, frm_mbr, "parta_detl", "parta_detl", ds, "-");
        }
        else
        {
            fgen.Print_Report(frm_cocd, frm_qstr, frm_mbr, SQuery, "parta_detl", "parta_detl");
        }
    }
    protected void txtsrch_TextChanged(object sender, EventArgs e)
    {
        dt1 = new DataTable();
        SQuery = ViewState["SQUERY"].ToString();
        dt = new DataTable();
        dt = (DataTable)ViewState["sg1"];
        // dt1 = fgen.search_vip1(co_cd, SQuery, txtsrch.Text.Trim().ToUpper(), dt);
        dt1 = fgen.search_vip1(frm_qstr, frm_cocd, SQuery, txtsrch.Text.Trim().ToUpper(), dt);
        dt = dt1;
        if (dt1.Rows.Count > 0)
        {
            fillgrid();
        }
        else
        {
            GridView1.DataSource = null;
            GridView1.DataBind();
        }
    }
    protected void btnexptoexl_Click(object sender, ImageClickEventArgs e)
    {
        dt = new DataTable();
        dt = (DataTable)ViewState["sg1"];
        if (dt.Rows.Count > 0) fgen.exp_to_excel(dt, "ms-excel", "xls", frm_cocd + "_Parta_Report_" + DateTime.Now.ToString().Trim());
        else fgen.msg("-", "AMSG", "No Data to Export"); dt.Dispose();
    }
}